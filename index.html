<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="spending.png" />
    <title>TALYEXP - Expense Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="TALYEXP.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
    <div id="splash-screen">
        <div><img class="splash-logo" src="spending.png" alt="TX"></div>
        <div class="splash-title">TALYEXP</div>
    </div>

    <div id="login-screen" class="login-screen" style="display:none">
        <div class="login-box">
            <div><img class="login-logo" src="spending.png" alt="TX"></div>
            <h2 id="auth-title">Welcome to talyexp</h2>
            <p id="auth-subtitle">Enter your credentials to access your dashboard</p>
            <div class="input-group">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.84,8c18.84-32.56,52.14-52,89.08-52s70.24,19.44,89.08,52a8,8,0,1,0,13.84-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z">
                        </path>
                    </svg></span>
                <input id="loginUser" class="input" placeholder="Username" />
            </div>
            <div class="input-group" id="pass-group">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96v96a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Zm-80,84a12,12,0,1,1,12-12A12,12,0,0,1,128,164Zm32-84H96V56a32,32,0,0,1,64,0Z">
                        </path>
                    </svg></span>
                <input id="loginPass" class="input" placeholder="Password" type="password" />
            </div>
            <div id="confirm-pass-group" class="input-group" style="display: none;">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96v96a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Zm-80,84a12,12,0,1,1,12-12A12,12,0,0,1,128,164Zm32-84H96V56a32,32,0,0,1,64,0Z">
                        </path>
                    </svg></span>
                <input id="confirmPass" class="input" placeholder="Confirm Password" type="password" />
            </div>
            <button id="authBtn" class="login-btn">Secure Sign In</button>
            <div class="auth-toggle">
                <span id="auth-toggle-text">Don't have an account?</span>
                <a id="auth-toggle-link">Sign Up</a>
            </div>
            <div class="auth-toggle" style="margin-top: 10px;">
                <a id="forgot-pass-link">Forgot Password?</a>
            </div>
        </div>
    </div>

    <div class="app-wrap" id="app-container">
        <header class="card">
            <div class="brand">
                <div><img class="logo" src="spending.png" alt="TX"></div>
                <div>
                    <h1>TALYEXP</h1>
                    <div id="user-greeting" class="subtitle"></div>
                </div>
            </div>

            <div class="header-right">
                <div class="top-actions" style="display:flex; gap: 8px; align-items:center;">
                    <select id="downloadPeriod" class="search-input small" style="width: 140px;"></select>
                    <button id="downloadBtn" class="btn small">Download Report</button>
                </div>
                <nav class="main-nav">
                    <button id="hamburger-btn" style="font-size: 28px; background: none; border: none; cursor: pointer;"
                        title="Take a bite!">
                        üçî
                    </button>

                    <div id="nav-links">
                        <button id="homeBtn" class="btn small active">Home</button>
                        <button id="txBtn" class="btn small ghost">Transactions</button>
                        <button id="savingsBtn" class="btn small ghost">Savings</button>
                        <button id="returnsBtn" class="btn small ghost">Returns</button>
                        <button id="payablesBtn" class="btn small ghost">Payables</button> <button id="fullResetBtn"
                            class="btn small danger">Reset App</button>
                        <button id="logoutBtn" class="btn ghost small">Logout</button>
                        <button id="calculatorBtn" class="btn ghost small" title="Calculator" style="padding: 6px 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                viewBox="0 0 256 256">
                                <path
                                    d="M184,32H72A16,16,0,0,0,56,48V208a16,16,0,0,0,16,16H184a16,16,0,0,0,16-16V48A16,16,0,0,0,184,32Zm0,176H72V48H184ZM128,80a12,12,0,1,1-12,12A12,12,0,0,1,128,80Zm36,28a12,12,0,1,1-12,12A12,12,0,0,1,164,108Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,128,108Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,92,108Zm72,36a12,12,0,1,1-12,12A12,12,0,0,1,164,144Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,128,144Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,92,144Zm72,36a12,12,0,1,1-12,12A12,12,0,0,1,164,180Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,128,180Z">
                                </path>
                            </svg>
                            <div class="calcbtn">Calculator</div>
                        </button>
                    </div>
                </nav>
            </div>
        </header>

        <main>
            <div id="home-view">
                <div class="app-grid">
                    <section class="left-column">
                        <div class="card" style="flex-shrink: 0;">
                            <h3 style="margin-top:0; color: var(--accent);">Smart Insights</h3>
                            <div id="smart-insights">
                                <p class="subtitle">Add more transactions to see smart suggestions.</p>
                            </div>
                        </div>
                        <div class="card" style="flex-grow: 1;">
                            <div style="display:flex; justify-content: space-between; align-items: center;">
                                <label for="monthlyIncome">Monthly Income (for selected month)</label>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center; margin-top: 6px;">
                                <input id="monthlyIncome" class="input" type="number"
                                    placeholder="Income for selected month" />
                                <button id="saveIncome" class="btn small">Save</button>
                            </div>
                            <div style="margin-top:8px" class="subtitle">Remaining this month: <strong
                                    id="remaining">‚Çπ0.00</strong></div>
                        </div>
                        <div class="card" style="flex-shrink: 0;">
                            <div>
                                <h4>Add your expensis:</h4>
                                <label for="title">Title (Expense)</label>
                                <input id="title" class="input" type="text" placeholder="e.g., Dinner with friends" />
                            </div>
                            <div class="form-row" style="margin-top: 14px;">
                                <div style="flex:1"><label for="amount">Amount (‚Çπ)</label><input id="amount"
                                        class="input" type="number" placeholder="0.00" /></div>
                                <div style="width:150px"><label for="date">Date</label><input id="date" class="input"
                                        type="date" /></div>
                            </div>
                            <div style="margin-top: 14px;">
                                <label for="category">Category</label>
                                <input id="category" type="text" class="input"
                                    placeholder="e.g., Food, Transport, Bills" />
                            </div>
                            <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                <button id="addBtn" class="btn">Add Expense</button>
                                <button id="voiceBtn" class="btn ghost" title="Add with Voice"
                                    style="padding: 8px 12px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        viewBox="0 0 256 256">
                                        <path
                                            d="M128,176a48.05,48.05,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48.05,48.05,0,0,0,128,176ZM96,64a32,32,0,0,1,64,0v64a32,32,0,0,1-64,0Zm40,151.6V240a8,8,0,0,1-16,0V215.6A80.05,80.05,0,0,1,48,128a8,8,0,0,1,16,0,64,64,0,0,0,128,0,8,8,0,0,1,16,0A80.05,80.05,0,0,1,136,215.6Z">
                                        </path>
                                    </svg>
                                </button>
                                <button id="updateBtn" class="btn ghost" style="display:none">Update</button>
                                <button id="resetBtn" class="btn ghost">Reset</button>
                            </div>
                        </div>

                        <div class="card" style="flex-shrink: 0;">
                            <div>
                                <h4>Add your savings:</h4>
                                <label for="saving-title">Title (Saving)</label>
                                <input id="saving-title" class="input" type="text" placeholder="e.g., Mutual Fund" />
                            </div>
                            <div class="form-row" style="margin-top: 14px;">
                                <div style="flex:1"><label for="saving-amount">Amount (‚Çπ)</label><input
                                        id="saving-amount" class="input" type="number" placeholder="0.00" /></div>
                                <div style="width:150px"><label for="saving-month">Month</label><input id="saving-month"
                                        class="input" type="month" /></div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                <button id="addSavingBtn" class="btn">Add Saving</button>
                            </div>
                        </div>

                        <div class="card" style="flex-shrink: 0;">
                            <div
                                style="display: flex; gap: -1px; border-bottom: 1px solid var(--glass); margin-bottom: 16px;">
                                <button id="toggle-return-form" class="btn form-toggle-btn active">Lent
                                    (Returns)</button>
                                <button id="toggle-payable-form" class="btn form-toggle-btn">To Pay (Payables)</button>
                            </div>

                            <div id="return-form-container">
                                <h4>Add details of amount lent (Pending Return)</h4>
                                <label for="return-person">Person's Name (Money given to)</label>
                                <input id="return-person" class="input" type="text" placeholder="e.g., John Doe" />
                                <div class="form-row" style="margin-top: 14px;">
                                    <div style="flex:1">
                                        <label for="return-amount">Amount (‚Çπ)</label>
                                        <input id="return-amount" class="input" type="number" placeholder="0.00" />
                                    </div>
                                    <div style="width:150px">
                                        <label for="return-date">Date Given</label>
                                        <input id="return-date" class="input" type="date" />
                                    </div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label for="return-mode">Payment Mode</label>
                                    <input id="return-mode" type="text" class="input" placeholder="e.g., UPI, Cash" />
                                </div>
                                <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                    <button id="addReturnBtn" class="btn">Add Return</button>
                                    <button id="updateReturnBtn" class="btn ghost" style="display:none">Update
                                        Return</button>
                                </div>
                            </div>

                            <div id="payable-form-container" style="display: none;">
                                <h4>Add details of amount to be given (Payable)</h4>
                                <label for="payable-person">Person's Name (Money to be given to)</label>
                                <input id="payable-person" class="input" type="text" placeholder="e.g., Jane Smith" />
                                <div class="form-row" style="margin-top: 14px;">
                                    <div style="flex:1">
                                        <label for="payable-amount">Amount (‚Çπ)</label>
                                        <input id="payable-amount" class="input" type="number" placeholder="0.00" />
                                    </div>
                                    <div style="width:150px">
                                        <label for="payable-date">Date</label>
                                        <input id="payable-date" class="input" type="date" />
                                    </div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label for="payable-mode">Payment Mode</label>
                                    <input id="payable-mode" type="text" class="input" placeholder="e.g., UPI, Cash" />
                                </div>
                                <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                    <button id="addPayableBtn" class="btn">Add Payable</button>
                                    <button id="updatePayableBtn" class="btn ghost" style="display:none">Update
                                        Payable</button>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="flex-shrink: 0;">
                            <div class="summary">
                                <div class="stat">
                                    <h3>Total</h3>
                                    <p id="totalAll">‚Çπ0.00</p>
                                </div>
                                <div class="stat">
                                    <h3>This Month</h3>
                                    <p id="totalMonth">‚Çπ0.00</p>
                                </div>
                                <div class="stat">
                                    <h3>Transactions</h3>
                                    <p id="countTx">0</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="right-column">
                        <div class="card" style="flex-grow: 1;">
                            <div
                                style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom:10px;">
                                <label for="chartPeriod" class="subtitle" style="margin:0;">Filter Charts:</label>
                                <select id="chartPeriod" class="search-input small" style="width: 140px;"></select>
                            </div>
                            <div class="charts-grid">
                                <div class="chart-card"><canvas id="monthlyBarChart"></canvas></div>
                                <div class="chart-card"><canvas id="categoryBarChart"></canvas></div>
                                <div class="chart-card"><canvas id="pieChart"></canvas></div>
                                <div class="chart-card"><canvas id="donutChart"></canvas></div>
                                <div class="chart-card"><canvas id="savingsBarChart"></canvas></div>
                                <div class="chart-card"><canvas id="cashFlowOverviewChart"></canvas></div>
                            </div><br>
                            <div class="chart-card"><canvas id="cashFlowTrendChart"></canvas></div>
                        </div>
                    </section>
                </div>
            </div>

            <div id="transactions-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Monthly Overview</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button id="downloadYearlyBtn" class="btn small ghost">Yearly Report</button>
                        <button id="downloadQuarterlyBtn" class="btn small ghost">Quarterly Report</button>
                        <input id="txSearch" class="search-input" placeholder="Search transactions..." />
                    </div>
                </div>

                <div id="txListContainer" class="tx-list-container">
                    <div id="txGrid" class="tx-grid"></div>
                </div>
            </div>

            <div id="savings-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Your Savings</h2>
                </div>
                <div id="savingsListContainer" class="tx-list-container">
                    <div id="savingsGrid" class="tx-grid">
                    </div>
                </div>
            </div>

            <div id="returns-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Pending Returns</h2>
                    <input id="returnsSearch" class="search-input" placeholder="Search by name..." />
                </div>
                <div id="returnsListContainer" class="tx-list-container">
                    <div id="returnsGrid" class="tx-grid">
                    </div>
                </div>
            </div>

            <div id="payables-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Upcoming Payables</h2>
                    <input id="payablesSearch" class="search-input" placeholder="Search by name..." />
                </div>
                <div id="payablesListContainer" class="tx-list-container">
                    <div id="payablesGrid" class="tx-grid">
                    </div>
                </div>
            </div>
        </main>
        <footer class="card" style="margin-top: 12px; padding: 12px; text-align: center;">
            <p style="margin:0; font-size: 14px; color: var(--muted);">
                Developed by <strong>PCJ</strong>
                <br> &copy; 2025 TALYEXP. All Rights Reserved.

            </p>
        </footer>
    </div>

    <div id="tx-modal" class="tx-modal">
        <div class="tx-modal-content">
            <div class="tx-modal-header">
                <h2 id="tx-modal-title">Month Details</h2>
                <button id="close-modal-btn" class="close-modal-btn">&times;</button>
            </div>
            <div id="tx-modal-body" class="tx-modal-body">
            </div>
        </div>
    </div>

    <div id="calculator-modal" class="reset-modal">
        <div id="calculator">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-keys">
                <button class="calc-key calc-key-op" data-key="clear">C</button>
                <button class="calc-key calc-key-op" data-key="/">/</button>
                <button class="calc-key calc-key-op" data-key="*">*</button>
                <button class="calc-key calc-key-op" data-key="-">-</button>
                <button class="calc-key" data-key="7">7</button>
                <button class="calc-key" data-key="8">8</button>
                <button class="calc-key" data-key="9">9</button>
                <button class="calc-key calc-key-op" data-key="+">+</button>
                <button class="calc-key" data-key="4">4</button>
                <button class="calc-key" data-key="5">5</button>
                <button class="calc-key" data-key="6">6</button>
                <button class="calc-key calc-key-equals" data-key="=">=</button>
                <button class="calc-key" data-key="1">1</button>
                <button class="calc-key" data-key="2">2</button>
                <button class="calc-key" data-key="3">3</button>
                <button class="calc-key calc-key-zero" data-key="0">0</button>
                <button class="calc-key" data-key=".">.</button>
            </div>
        </div>
    </div>
    <script>
        // --- App State & Constants ---
        const SESSION_KEY = 'talyexp_v1:session';
        // --- UPDATE: Set EXCLUDE_CATEGORY to empty string to include 'PG Rent' in all totals ---
        const EXCLUDE_CATEGORY = ''; // Was 'PG Rent'
        let expenses = [];
        let savings = [];
        let groupedExpenses = {};
        let groupedSavings = {}; // --- UPDATE: Added for new UI ---

        // --- NEW: Pending Returns State ---
        let returns = [];
        let groupedReturns = {};
        let editingReturnId = null;

        // --- NEW: Payables State ---
        let payables = [];
        let editingPayableId = null;

        let meta = { startTs: Date.now() };
        let editingId = null;
        let monthlyIncomes = {};
        let chartInstances = {};
        let authMode = 'login'; // --- UPDATE: 'login', 'register', 'reset' ---

        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const authBtn = document.getElementById('authBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const fullResetBtn = document.getElementById('fullResetBtn');
        const homeBtn = document.getElementById('homeBtn');
        const txBtn = document.getElementById('txBtn');
        const savingsBtn = document.getElementById('savingsBtn');
        const returnsBtn = document.getElementById('returnsBtn'); // --- NEW ---
        const payablesBtn = document.getElementById('payablesBtn'); // üëà ADDED
        const homeView = document.getElementById('home-view');
        const transactionsView = document.getElementById('transactions-view');
        const savingsView = document.getElementById('savings-view');
        const returnsView = document.getElementById('returns-view'); // --- NEW ---
        const payablesView = document.getElementById('payables-view'); // üëà ADDED

        const titleEl = document.getElementById('title');
        const amountEl = document.getElementById('amount');
        const dateEl = document.getElementById('date');
        const categoryEl = document.getElementById('category');
        const addBtn = document.getElementById('addBtn');
        const updateBtn = document.getElementById('updateBtn');
        const resetBtn = document.getElementById('resetBtn');

        const savingTitleEl = document.getElementById('saving-title');
        const savingAmountEl = document.getElementById('saving-amount');
        const savingMonthEl = document.getElementById('saving-month');
        const addSavingBtn = document.getElementById('addSavingBtn');
        const savingsGrid = document.getElementById('savingsGrid'); // --- UPDATE ---

        // --- NEW: Pending Return DOM Elements ---
        const returnPersonEl = document.getElementById('return-person');
        const returnAmountEl = document.getElementById('return-amount');
        const returnDateEl = document.getElementById('return-date');
        const returnModeEl = document.getElementById('return-mode');
        const addReturnBtn = document.getElementById('addReturnBtn');
        const updateReturnBtn = document.getElementById('updateReturnBtn');
        const returnsGrid = document.getElementById('returnsGrid');
        const returnsSearch = document.getElementById('returnsSearch');

        // --- NEW: Payable DOM Elements (from new HTML) ---
        const payablePersonEl = document.getElementById('payable-person');
        const payableAmountEl = document.getElementById('payable-amount');
        const payableDateEl = document.getElementById('payable-date');
        const payableModeEl = document.getElementById('payable-mode');
        const addPayableBtn = document.getElementById('addPayableBtn');
        const updatePayableBtn = document.getElementById('updatePayableBtn'); // üëà ADDED
        const toggleReturnBtn = document.getElementById('toggle-return-form');
        const togglePayableBtn = document.getElementById('toggle-payable-form');
        const returnFormContainer = document.getElementById('return-form-container');
        const payableFormContainer = document.getElementById('payable-form-container');
        const payablesGrid = document.getElementById('payablesGrid'); // üëà ADDED
        const payablesSearch = document.getElementById('payablesSearch'); // üëà ADDED


        const totalAll = document.getElementById('totalAll');
        const totalMonth = document.getElementById('totalMonth');
        const countTx = document.getElementById('countTx');
        const downloadPeriod = document.getElementById('downloadPeriod');
        const downloadBtn = document.getElementById('downloadBtn');
        const chartPeriod = document.getElementById('chartPeriod');
        const monthlyIncomeEl = document.getElementById('monthlyIncome');
        const saveIncomeBtn = document.getElementById('saveIncome');
        const remainingEl = document.getElementById('remaining');
        const txSearch = document.getElementById('txSearch');
        // const resetModal = document.getElementById('reset-modal'); // --- UPDATE: Modal removed ---
        // const downloadArchiveBtn = document.getElementById('downloadArchiveBtn'); // --- UPDATE: Button removed ---
        const authToggleLink = document.getElementById('auth-toggle-link');
        const forgotPassLink = document.getElementById('forgot-pass-link'); // --- UPDATE ---
        const passGroup = document.getElementById('pass-group'); // --- UPDATE ---
        const confirmPassGroup = document.getElementById('confirm-pass-group');
        const loginUserEl = document.getElementById('loginUser');
        const loginPassEl = document.getElementById('loginPass');
        const confirmPassEl = document.getElementById('confirmPass');
        const txGrid = document.getElementById('txGrid');
        const txModal = document.getElementById('tx-modal');
        const txModalTitle = document.getElementById('tx-modal-title');
        const txModalBody = document.getElementById('tx-modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const downloadYearlyBtn = document.getElementById('downloadYearlyBtn');
        const downloadQuarterlyBtn = document.getElementById('downloadQuarterlyBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const calculatorModal = document.getElementById('calculator-modal');
        const calculatorBtn = document.getElementById('calculatorBtn');
        const userGreetingEl = document.getElementById('user-greeting');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const navLinks = document.getElementById('nav-links');

        // --- Utility Functions ---
        const numberFormat = (n) => Number(n).toLocaleString('en-IN', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        const formatDate = (d) => new Date(d).toLocaleDateString('en-GB');
        const escapeHtml = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // --- Authentication ---
        const isLoggedIn = () => !!sessionStorage.getItem(SESSION_KEY);

        function validatePassword(password) {
            if (password.length < 10) { alert(`Password must be at least 10 characters long.`); return false; }
            if (!/[A-Z]/.test(password)) { alert('Password must contain at least one uppercase letter.'); return false; }
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) { alert('Password must contain at least one special character.'); return false; }
            return true;
        }

        async function handleAuth() {
            const username = loginUserEl.value.trim().toLowerCase();
            const password = loginPassEl.value;
            if (!username) {
                alert('Username cannot be empty.');
                return;
            }
            try {
                if (authMode === 'login') {
                    if (!password) { alert('Password cannot be empty.'); return; }
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Invalid credentials');
                    sessionStorage.setItem(SESSION_KEY, username);
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'flex';
                    await loadDataAndRender();
                } else if (authMode === 'register') {
                    const confirmPass = confirmPassEl.value;
                    if (password !== confirmPass) { alert('Passwords do not match.'); return; }
                    if (!validatePassword(password)) return;
                    const res = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Registration failed');
                    alert('Account created successfully! Please sign in.');
                    toggleAuthMode('login');
                } else if (authMode === 'reset') { // --- UPDATE: Handle reset ---
                    const newPassword = confirmPassEl.value;
                    if (!validatePassword(newPassword)) return;
                    if (!confirm('Are you sure you want to reset the password for this user?')) return;
                    const res = await fetch('/api/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, newPassword })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Password reset failed');
                    alert('Password reset successfully! Please sign in with your new password.');
                    toggleAuthMode('login');
                }
            } catch (err) {
                alert(`Authentication Error: ${err.message}`);
            }
        }

        function handleLogout() {
            sessionStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        // --- UPDATE: Toggle auth mode logic ---
        function toggleAuthMode(mode) {
            authMode = mode;
            loginUserEl.value = loginPassEl.value = confirmPassEl.value = '';
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');

            // --- FIX: Use auth-toggle-text and auth-toggle-link ---
            const authToggleText = document.getElementById('auth-toggle-text');
            const authToggleLink = document.getElementById('auth-toggle-link');

            if (authMode === 'login') {
                authTitle.textContent = 'Welcome Back';
                authSubtitle.textContent = 'Enter your credentials to access your dashboard';
                authBtn.textContent = 'Secure Sign In';
                passGroup.style.display = 'block';
                confirmPassGroup.style.display = 'none';
                authToggleText.textContent = "Don't have an account? ";
                authToggleLink.textContent = 'Sign Up';
                forgotPassLink.style.display = 'block';
            } else if (authMode === 'register') {
                authTitle.textContent = 'Create Account';
                authSubtitle.textContent = 'Create a new account to get started';
                authBtn.textContent = 'Sign Up';
                passGroup.style.display = 'block';
                confirmPassGroup.style.display = 'block';
                confirmPassEl.placeholder = "Confirm Password";
                authToggleText.textContent = "Already have an account? ";
                authToggleLink.textContent = 'Sign In';
                forgotPassLink.style.display = 'none';
            } else if (authMode === 'reset') {
                authTitle.textContent = 'Reset Password';
                authSubtitle.textContent = 'Enter username and your new password';
                authBtn.textContent = 'Reset Password';
                passGroup.style.display = 'none';
                confirmPassGroup.style.display = 'block';
                confirmPassEl.placeholder = "Enter New Password";
                authToggleText.textContent = "Remembered your password? ";
                authToggleLink.textContent = 'Sign In';
                forgotPassLink.style.display = 'none';
            }
        }

        // --- View Management ---
        function showView(viewId) {
            homeView.style.display = 'none';
            transactionsView.style.display = 'none';
            savingsView.style.display = 'none';
            returnsView.style.display = 'none'; // --- NEW ---
            payablesView.style.display = 'none'; // üëà ADDED
            homeBtn.classList.remove('active', 'ghost');
            txBtn.classList.remove('active', 'ghost');
            savingsBtn.classList.remove('active', 'ghost');
            returnsBtn.classList.remove('active', 'ghost'); // --- NEW ---
            payablesBtn.classList.remove('active', 'ghost'); // üëà ADDED

            // --- NEW: Add 'ghost' to all buttons first ---
            [homeBtn, txBtn, savingsBtn, returnsBtn, payablesBtn].forEach(btn => btn.classList.add('ghost')); // üëà UPDATED

            if (viewId === 'home') {
                homeView.style.display = 'block';
                homeBtn.classList.add('active');
                homeBtn.classList.remove('ghost');
                // --- UPDATE: Refresh charts on showing home view to prevent shrinking ---
                renderAllCharts();
                // --- END UPDATE ---
            } else if (viewId === 'transactions') {
                transactionsView.style.display = 'block';
                txBtn.classList.add('active');
                txBtn.classList.remove('ghost');
                renderTransactions();
            } else if (viewId === 'savings') {
                savingsView.style.display = 'block';
                savingsBtn.classList.add('active');
                savingsBtn.classList.remove('ghost');
                renderSavings();
            } else if (viewId === 'returns') { // --- NEW ---
                returnsView.style.display = 'block';
                returnsBtn.classList.add('active');
                returnsBtn.classList.remove('ghost');
                renderReturns();
            } else if (viewId === 'payables') { // üëà ADDED BLOCK
                payablesView.style.display = 'block';
                payablesBtn.classList.add('active');
                payablesBtn.classList.remove('ghost');
                renderPayables();
            }
        }

        // --- Data Persistence (Backend) ---
        async function loadDataAndRender() {
            const user = sessionStorage.getItem(SESSION_KEY);
            if (!user) return;
            try {
                // --- NEW: Fetch returns and payables data ---
                const [expensesRes, incomeRes, metaRes, savingsRes, returnsRes, payablesRes] = await Promise.all([
                    fetch(`/api/expenses/${user}`),
                    fetch(`/api/income/${user}`),
                    fetch(`/api/meta/${user}`),
                    fetch(`/api/savings/${user}`),
                    fetch(`/api/returns/${user}`), // --- NEW ---
                    fetch(`/api/payables/${user}`) // --- NEW ---
                ]);
                if (!expensesRes.ok || !incomeRes.ok || !metaRes.ok || !savingsRes.ok || !returnsRes.ok || !payablesRes.ok) { // --- NEW ---
                    throw new Error('Failed to fetch user data from server.');
                }
                expenses = await expensesRes.json();
                const incomeData = await incomeRes.json();
                meta = await metaRes.json();
                savings = await savingsRes.json();
                returns = await returnsRes.json(); // --- NEW ---
                payables = await payablesRes.json(); // --- NEW ---

                monthlyIncomes = incomeData.reduce((acc, item) => {
                    acc[item.monthKey] = item.income;
                    return acc;
                }, {});
                const capitalizedUser = user.charAt(0).toUpperCase() + user.slice(1);
                userGreetingEl.innerHTML = `Welcome, <strong style="color: var(--accent);">${escapeHtml(capitalizedUser)}</strong>`;

                // --- UPDATE: 1-Year Reset Check is removed ---
                // if (checkYearReset()) return; 

                renderHome();

                if (transactionsView.style.display === 'block') {
                    renderTransactions();
                } else if (savingsView.style.display === 'block') {
                    renderSavings();
                } else if (returnsView.style.display === 'block') { // --- NEW ---
                    renderReturns();
                } else if (payablesView.style.display === 'block') { // üëà ADDED
                    renderPayables();
                }
            } catch (err) {
                console.error('Error loading data:', err);
                alert('Could not load your data. Please try again later.');
                handleLogout();
            }
        }

        // --- Rendering ---
        function renderHome() {
            // --- UPDATE: 'PG Rent' is now included in totals because EXCLUDE_CATEGORY is "" ---
            const analysisExpenses = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.category !== EXCLUDE_CATEGORY)
                : expenses;

            const total = analysisExpenses.reduce((s, x) => s + Number(x.amount), 0);
            totalAll.textContent = numberFormat(total);
            const today = new Date();
            const ym = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const monthTotal = analysisExpenses.filter(e => e.date.startsWith(ym)).reduce((s, x) => s + Number(x.amount), 0);
            totalMonth.textContent = numberFormat(monthTotal);
            countTx.textContent = analysisExpenses.length;
            renderIncomeForSelectedMonth();
            renderAllCharts();
            generateSmartInsights();
        }

        function renderIncomeForSelectedMonth() {
            const selectedDateStr = dateEl.value;
            if (!selectedDateStr) return;
            const monthKey = selectedDateStr.slice(0, 7);
            const incomeForMonth = monthlyIncomes[monthKey] || 0;
            monthlyIncomeEl.value = incomeForMonth > 0 ? incomeForMonth : '';

            // --- UPDATE: 'PG Rent' is now included in monthTotal because EXCLUDE_CATEGORY is "" ---
            const monthTotal = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.date.startsWith(monthKey) && e.category !== EXCLUDE_CATEGORY).reduce((sum, e) => sum + Number(e.amount), 0)
                : expenses.filter(e => e.date.startsWith(monthKey)).reduce((sum, e) => sum + Number(e.amount), 0);

            const monthSavings = savings
                .filter(s => s.monthKey === monthKey)
                .reduce((sum, s) => sum + Number(s.amount), 0);
            const remaining = Math.max(0, incomeForMonth - monthTotal - monthSavings);

            remainingEl.textContent = numberFormat(remaining);
        }

        function renderTransactions() {
            const query = txSearch.value.trim().toLowerCase();
            const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            const list = query
                ? sorted.filter(e =>
                    e.title.toLowerCase().includes(query) ||
                    e.category.toLowerCase().includes(query)
                )
                : sorted;

            txGrid.innerHTML = '';
            if (list.length === 0) {
                txGrid.innerHTML = `<div class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No transactions found.</div>`;
                return;
            }

            groupedExpenses = list.reduce((acc, tx) => {
                let d = new Date(tx.date);
                if (isNaN(d)) { try { d = new Date(String(tx.date).split('T')[0]); } catch { return acc; } }
                if (isNaN(d)) return acc;

                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                if (!acc[monthKey]) acc[monthKey] = { label, transactions: [], total: 0 };
                acc[monthKey].transactions.push(tx);
                acc[monthKey].total += Number(tx.amount) || 0;
                return acc;
            }, {});

            const sortedKeys = Object.keys(groupedExpenses).sort().reverse();

            for (const key of sortedKeys) {
                const group = groupedExpenses[key];
                const card = document.createElement('div');
                card.className = 'month-card';
                card.dataset.key = key;
                card.innerHTML = `
                    <h3>${group.label}</h3>
                    <p>Total: <strong>${numberFormat(group.total)}</strong></p>
                    <p>${group.transactions.length} Transactions</p>`;
                card.onclick = () => showMonthDetails(key, 'expense'); // --- UPDATE: Pass type ---
                txGrid.appendChild(card);
            }
        }

        // --- UPDATE: New renderSavings function ---
        function renderSavings() {
            savingsGrid.innerHTML = '';
            if (savings.length === 0) {
                savingsGrid.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No savings recorded yet.</p>`;
                return;
            }

            groupedSavings = savings.reduce((acc, s) => {
                const [year, month] = s.monthKey.split('-');
                const label = new Date(year, month - 1, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                if (!acc[s.monthKey]) {
                    acc[s.monthKey] = { label, items: [], total: 0 };
                }
                acc[s.monthKey].items.push(s);
                acc[s.monthKey].total += Number(s.amount);
                return acc;
            }, {});

            const sortedKeys = Object.keys(groupedSavings).sort().reverse();
            for (const key of sortedKeys) {
                const group = groupedSavings[key];
                const card = document.createElement('div');
                card.className = 'month-card';
                card.dataset.key = key;
                card.innerHTML = `
                    <h3>${group.label}</h3>
                    <p>Total Saved: <strong>${numberFormat(group.total)}</strong></p>
                    <p>${group.items.length} Savings</p>`;
                card.onclick = () => showMonthDetails(key, 'saving'); // --- UPDATE: Pass type ---
                savingsGrid.appendChild(card);
            }
        }

        // --- NEW: renderReturns function ---
        function renderReturns() {
            const query = returnsSearch.value.trim().toLowerCase();
            const sorted = [...returns].sort((a, b) => new Date(b.date) - new Date(a.date));
            const list = query
                ? sorted.filter(r => r.personName.toLowerCase().includes(query))
                : sorted;

            returnsGrid.innerHTML = '';
            if (list.length === 0) {
                returnsGrid.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No pending returns found.</p>`;
                return;
            }

            // Note: We are not grouping returns by month, but showing them as individual cards.
            // The prompt asked for "3 cards in a row" which the 'tx-grid' class already handles.
            for (const item of list) {
                const card = document.createElement('div');
                card.className = 'month-card'; // Re-using style for consistency
                card.innerHTML = `
                    <h3 style="color: #fbbf24;">${escapeHtml(item.personName)}</h3>
                    <p>Amount: <strong>${numberFormat(item.amount)}</strong></p>
                    <p>Date: ${formatDate(item.date)}</p>
                    <p>Mode: ${escapeHtml(item.paymentMode)}</p>
                    <div style="display:flex; gap: 8px; margin-top: 12px;">
                        <button class="btn small" onclick="editReturn('${item._id}')" style="flex:1; background-color: #60a5fa; color: #fff;">Update</button>
                        <button class="btn small danger" onclick="deleteReturn('${item._id}')" style="flex:1;">Received</button>
                    </div>`;
                returnsGrid.appendChild(card);
            }
        }

        // --- NEW: renderPayables function ---
        function renderPayables() {
            const query = payablesSearch.value.trim().toLowerCase();
            // Sort by date ascending (closest due date first)
            const sorted = [...payables].sort((a, b) => new Date(a.date) - new Date(b.date));
            const list = query
                ? sorted.filter(p => p.personName.toLowerCase().includes(query))
                : sorted;

            payablesGrid.innerHTML = '';
            if (list.length === 0) {
                payablesGrid.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No upcoming payables found.</p>`;
                return;
            }

            for (const item of list) {
                const card = document.createElement('div');
                card.className = 'month-card'; // Re-using style for consistency
                card.innerHTML = `
                    <h3 style="color: #fb7185;">${escapeHtml(item.personName)}</h3>
                    <p>Amount: <strong>${numberFormat(item.amount)}</strong></p>
                    <p>Date: ${formatDate(item.date)}</p>
                    <p>Mode: ${escapeHtml(item.paymentMode)}</p>
                    <div style="display:flex; gap: 8px; margin-top: 12px;">
                        <button class="btn small" onclick="editPayable('${item._id}')" style="flex:1; background-color: #60a5fa; color: #fff;">Update</button>
                        <button class="btn small danger" onclick="deletePayable('${item._id}')" style="flex:1;">Paid</button>
                    </div>`;
                payablesGrid.appendChild(card);
            }
        }


        // --- UPDATE: Re-purposed showMonthDetails for expenses and savings ---
        window.showMonthDetails = (monthKey, type) => {
            let group, items;
            if (type === 'expense') {
                group = groupedExpenses[monthKey];
                items = group.transactions;
                txModalTitle.textContent = `${group.label} - Expenses`;
            } else { // type === 'saving'
                group = groupedSavings[monthKey];
                items = group.items;
                txModalTitle.textContent = `${group.label} - Savings`;
            }

            if (!group || !items) { alert('No data found for this month.'); return; }

            txModalBody.innerHTML = '';

            for (const e of items) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'expense-item'; // Reuse class for styling

                if (type === 'expense') {
                    const d = new Date(e.date);
                    const safeDate = isNaN(d) ? e.date : formatDate(d);
                    const safeCat = escapeHtml(e.category || 'Misc');
                    const safeTitle = escapeHtml(e.title || '(Untitled)');
                    const safeAmount = numberFormat(e.amount || 0);

                    itemDiv.innerHTML = `
                        <div class="expense-left">
                            <div class="cat-badge">${safeCat.slice(0, 2).toUpperCase()}</div>
                            <div>
                                <div style="font-weight:700">${safeTitle}</div>
                                <div class="meta">${safeDate} ‚Ä¢ ${safeCat}</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div class="amount">${safeAmount}</div>
                            <div class="controls">
                                <button class="btn ghost small" onclick="editExpense('${e._id}')">Edit</button>
                                <button class="btn ghost small" onclick="deleteExpense('${e._id}')">Delete</button>
                            </div>
                        </div>`;
                } else { // type === 'saving'
                    const safeTitle = escapeHtml(e.title || '(Untitled)');
                    const safeAmount = numberFormat(e.amount || 0);
                    itemDiv.innerHTML = `
                        <div class="expense-left">
                            <div class="cat-badge" style="background-color: rgba(167, 139, 250, 0.2); color: #a78bfa;">SV</div>
                            <div>
                                <div style="font-weight:700">${safeTitle}</div>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div class="amount" style="color: #a78bfa;">${safeAmount}</div>
                            <div class="controls">
                                <button class="btn ghost small" onclick="deleteSaving('${e._id}')">Delete</button>
                            </div>
                        </div>`;
                }
                txModalBody.appendChild(itemDiv);
            }
            txModal.style.display = 'flex';
        };

        // --- Form Handling ---
        function resetForm() {
            titleEl.value = '';
            amountEl.value = '';
            dateEl.value = new Date().toISOString().slice(0, 10);
            categoryEl.value = '';
            editingId = null;
            updateBtn.style.display = 'none';
            addBtn.style.display = 'inline-block';
            renderIncomeForSelectedMonth();
        }

        // --- NEW: Reset Return Form ---
        function resetReturnForm() {
            returnPersonEl.value = '';
            returnAmountEl.value = '';
            returnDateEl.value = new Date().toISOString().slice(0, 10);
            returnModeEl.value = '';
            editingReturnId = null;
            updateReturnBtn.style.display = 'none';
            addReturnBtn.style.display = 'inline-block';
        }

        // --- NEW: Reset Payable Form ---
        function resetPayableForm() {
            payablePersonEl.value = '';
            payableAmountEl.value = '';
            payableDateEl.value = new Date().toISOString().slice(0, 10);
            payableModeEl.value = '';
            editingPayableId = null;
            updatePayableBtn.style.display = 'none'; // üëà UPDATED
            addPayableBtn.style.display = 'inline-block'; // üëà UPDATED
        }

        window.editExpense = (id) => {
            txModal.style.display = 'none';
            const item = expenses.find(e => e._id === id);
            if (!item) return;
            showView('home');
            titleEl.value = item.title;
            amountEl.value = item.amount;
            dateEl.value = item.date;
            categoryEl.value = item.category;
            editingId = id;
            addBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
            titleEl.focus();
            renderIncomeForSelectedMonth();
        };

        // --- NEW: editReturn ---
        window.editReturn = (id) => {
            const item = returns.find(r => r._id === id);
            if (!item) return;
            showView('home');
            // --- NEW: Show the correct form tab ---
            toggleReturnBtn.click();
            // ---
            returnPersonEl.value = item.personName;
            returnAmountEl.value = item.amount;
            returnDateEl.value = new Date(item.date).toISOString().slice(0, 10);
            returnModeEl.value = item.paymentMode;
            editingReturnId = id;
            addReturnBtn.style.display = 'none';
            updateReturnBtn.style.display = 'inline-block';
            returnPersonEl.focus();
        };

        // --- NEW: editPayable ---
        window.editPayable = (id) => {
            const item = payables.find(p => p._id === id);
            if (!item) return;
            showView('home');
            // Show the correct form tab
            togglePayableBtn.click();

            payablePersonEl.value = item.personName;
            payableAmountEl.value = item.amount;
            payableDateEl.value = new Date(item.date).toISOString().slice(0, 10);
            payableModeEl.value = item.paymentMode;
            editingPayableId = id;
            addPayableBtn.style.display = 'none';
            updatePayableBtn.style.display = 'inline-block';
            payablePersonEl.focus();
        };

        window.deleteExpense = async (id) => {
            if (!confirm('Are you sure you want to delete this expense?')) return;
            try {
                const res = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete expense from server.');
                await loadDataAndRender(); // Reloads all data
                // --- FIX: Correctly reopen modal ---
                const monthLabel = txModalTitle.textContent.split(' - ')[0];
                const monthKey = Object.keys(groupedExpenses).find(key => groupedExpenses[key].label === monthLabel);
                if (monthKey && groupedExpenses[monthKey].transactions.length > 0) {
                    showMonthDetails(monthKey, 'expense'); // Re-open modal if items remain
                } else {
                    txModal.style.display = 'none';
                    if (transactionsView.style.display === 'block') renderTransactions(); // Refresh view
                }
            } catch (err) {
                alert(err.message);
            }
        };

        // --- UPDATE: New deleteSaving function ---
        window.deleteSaving = async (id) => {
            if (!confirm('Are you sure you want to delete this saving entry?')) return;
            try {
                const res = await fetch(`/api/savings/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete saving from server.');
                await loadDataAndRender(); // Reloads all data
                const monthLabel = txModalTitle.textContent.split(' - ')[0];
                const monthKey = Object.keys(groupedSavings).find(key => groupedSavings[key].label === monthLabel);
                if (monthKey && groupedSavings[monthKey].items.length > 0) {
                    showMonthDetails(monthKey, 'saving'); // Re-open modal if items remain
                } else {
                    txModal.style.display = 'none'; // Close modal if no items remain
                    if (savingsView.style.display === 'block') renderSavings(); // Refresh view
                }
            } catch (err) {
                alert(err.message);
            }
        };

        // --- NEW: deleteReturn (Received) ---
        window.deleteReturn = async (id) => {
            if (!confirm('Are you sure you have received this payment? This will remove the entry.')) return;
            try {
                const res = await fetch(`/api/returns/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to mark return as received.');
                await loadDataAndRender(); // Reloads all data
                // No modal to reopen, just re-render the view if it's active
                if (returnsView.style.display === 'block') {
                    renderReturns();
                }
            } catch (err) {
                alert(err.message);
            }
        };

        // --- NEW: deletePayable (Paid) ---
        window.deletePayable = async (id) => {
            if (!confirm('Are you sure you have paid this? This will remove the entry.')) return;
            try {
                const res = await fetch(`/api/payables/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to mark payable as paid.');
                await loadDataAndRender(); // Reloads all data
                // Re-render the view if it's active
                if (payablesView.style.display === 'block') {
                    renderPayables();
                }
            } catch (err) {
                alert(err.message);
            }
        };


        // --- Charting ---
        function getFilteredExpenses() {
            const period = chartPeriod.value;
            // --- UPDATE: 'PG Rent' is no longer filtered here ---
            const filteredBase = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.category !== EXCLUDE_CATEGORY)
                : expenses;

            if (!period.match(/^\d{4}-\d{2}$/)) return [];
            const [year, month] = period.split('-').map(Number);
            return filteredBase.filter(e => {
                const d = new Date(e.date);
                return d.getFullYear() === year && d.getMonth() === (month - 1);
            });
        }

        // --- UPDATE: New function to get filtered savings ---
        function getFilteredSavings() {
            const period = chartPeriod.value;
            if (!period.match(/^\d{4}-\d{2}$/)) return [];
            return savings.filter(s => s.monthKey === period);
        }

        function renderAllCharts() {
            // --- FIX for graph shrinking bug: ---
            // Ensure data is available before rendering
            if (!expenses || !savings) return;

            renderMonthlyBarChart();
            renderCategoryBarChart();
            renderPieChart();
            renderDonutChart();
            renderSavingsBarChart(); // --- UPDATE ---
            // --- UPDATE: New Graph ---
            renderCashFlowOverviewChart();
            // --- END UPDATE ---
            renderCashFlowTrendChart();
        }

        function createChart(canvasId, type, data, options) {
            // --- FIX for graph shrinking bug: ---
            // Check if canvas exists
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas with ID ${canvasId} not found.`);
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Could not get 2D context for ${canvasId}.`);
                return;
            }
            // Destroy existing instance *before* creating a new one
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            chartInstances[canvasId] = new Chart(ctx, { type, data, options });
        }

        const chartDefaultOptions = { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255,255,255,0.1)' } } } };

        function renderMonthlyBarChart() {
            const labels = [], dataPoints = [], now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));

                // --- UPDATE: 'PG Rent' is now included ---
                const sum = (EXCLUDE_CATEGORY)
                    ? expenses.filter(e => e.date.startsWith(key) && e.category !== EXCLUDE_CATEGORY).reduce((a, b) => a + Number(b.amount), 0)
                    : expenses.filter(e => e.date.startsWith(key)).reduce((a, b) => a + Number(b.amount), 0);

                dataPoints.push(sum);
            }
            const canvas = document.getElementById('monthlyBarChart');
            if (!canvas) return; // --- FIX: Check canvas ---
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(110, 231, 183, 0.8)');
            gradient.addColorStop(1, 'rgba(110, 231, 183, 0.1)');
            createChart('monthlyBarChart', 'bar', { labels, datasets: [{ label: 'Monthly Spend', data: dataPoints, backgroundColor: gradient, borderColor: 'var(--accent)', borderWidth: 1 }] }, { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, title: { display: true, text: 'Last 6 Months Spend', color: '#FFFFFF' } } });
        }

        function renderCategoryBarChart() {
            const data = getFilteredExpenses(); // This now includes 'PG Rent'
            const categoryTotals = data.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
            const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            const colors = ["#60a5fa", "#fbbf24", "#fb7185", "#a78bfa", "#f87171", "#6ee7b7", "#f472b6"];
            createChart('categoryBarChart', 'bar', { labels: sorted.map(item => item[0]), datasets: [{ label: 'By Category', data: sorted.map(item => item[1]), backgroundColor: colors }] }, { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, title: { display: true, text: 'Spend by Category (Selected Month)', color: '#FFFFFF' } } });
        }

        function renderPieChart() {
            const data = getFilteredExpenses(); // This now includes 'PG Rent'
            const categoryTotals = data.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
            const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            createChart('pieChart', 'pie', { labels: sorted.map(item => item[0]), datasets: [{ data: sorted.map(item => item[1]), backgroundColor: ["#6ee7b7", "#60a5fa", "#fbbf24", "#fb7185", "#a78bfa", "#f472b6", "#f87171"] }] }, { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#FFFFFF' } } } });
        }

        function renderDonutChart() {
            const data = getFilteredExpenses(); // This now includes 'PG Rent'
            const spent = data.reduce((s, x) => s + Number(x.amount), 0);
            const monthKey = chartPeriod.value;
            const incomeForSelectedMonth = monthlyIncomes[monthKey] || 0;
            const budget = incomeForSelectedMonth;

            if (budget > 0) {
                const monthSavings = getFilteredSavings().reduce((sum, s) => sum + Number(s.amount), 0);
                const remaining = Math.max(0, budget - spent - monthSavings);
                createChart('donutChart', 'doughnut', { labels: ['Spent', 'Saved', 'Remaining'], datasets: [{ data: [spent, monthSavings, remaining], backgroundColor: ['#fb7185', '#a78bfa', '#60a5fa'], borderWidth: 0 }] }, { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#FFFFFF' } } } });
            } else {
                const categoryTotals = data.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
                const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
                createChart('donutChart', 'doughnut', { labels: sorted.map(item => item[0]), datasets: [{ data: sorted.map(item => item[1]), backgroundColor: ["#fb7185", "#60a5fa", "#fbbf24", "#a78bfa", "#6ee7b7", "#f472b6"], borderWidth: 0 }] }, { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#FFFFFF' } } } });
            }
        }

        // --- UPDATE: New Savings Bar Chart ---
        function renderSavingsBarChart() {
            const labels = [], dataPoints = [], now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));
                const sum = savings
                    .filter(s => s.monthKey === key)
                    .reduce((a, b) => a + Number(b.amount), 0);
                dataPoints.push(sum);
            }
            const canvas = document.getElementById('savingsBarChart');
            if (!canvas) return; // --- FIX: Check canvas ---
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(167, 139, 250, 0.8)');
            gradient.addColorStop(1, 'rgba(167, 139, 250, 0.1)');
            createChart('savingsBarChart', 'bar', { labels, datasets: [{ label: 'Monthly Savings', data: dataPoints, backgroundColor: gradient, borderColor: '#a78bfa', borderWidth: 1 }] }, { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, title: { display: true, text: 'Last 6 Months Savings', color: '#FFFFFF' } } });
        }

        // --- UPDATE: New Cash Flow Overview Chart ---
        function renderCashFlowOverviewChart() {
            const labels = [], incomePoints = [], expensePoints = [], savingPoints = [], now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));

                // Get Income
                incomePoints.push(monthlyIncomes[key] || 0);

                // Get Expenses (This now includes 'PG Rent')
                const expenseSum = (EXCLUDE_CATEGORY)
                    ? expenses.filter(e => e.date.startsWith(key) && e.category !== EXCLUDE_CATEGORY).reduce((a, b) => a + Number(b.amount), 0)
                    : expenses.filter(e => e.date.startsWith(key)).reduce((a, b) => a + Number(b.amount), 0);
                expensePoints.push(expenseSum);

                // Get Savings
                const savingSum = savings
                    .filter(s => s.monthKey === key)
                    .reduce((a, b) => a + Number(b.amount), 0);
                savingPoints.push(savingSum);
            }

            const canvas = document.getElementById('cashFlowOverviewChart');
            if (!canvas) return;

            createChart('cashFlowOverviewChart', 'bar', {
                labels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomePoints,
                        backgroundColor: 'rgba(110, 231, 183, 0.6)', // --accent
                        borderColor: 'var(--accent)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expense',
                        data: expensePoints,
                        backgroundColor: 'rgba(251, 113, 133, 0.6)', // --danger
                        borderColor: '#fb7185',
                        borderWidth: 1
                    },
                    {
                        label: 'Savings',
                        data: savingPoints,
                        backgroundColor: 'rgba(167, 139, 250, 0.6)', // purple
                        borderColor: '#a78bfa',
                        borderWidth: 1
                    }
                ]
            }, {
                ...chartDefaultOptions,
                plugins: {
                    ...chartDefaultOptions.plugins,
                    title: { display: true, text: 'Last 6 Months: Income vs. Spend vs. Savings', color: '#FFFFFF' },
                    legend: { display: true, position: 'bottom', labels: { color: '#FFFFFF' } } // Turn on legend for this chart
                },
                scales: {
                    y: { ...chartDefaultOptions.scales.y, beginAtZero: true },
                    x: { ...chartDefaultOptions.scales.x }
                }
            });
        }
        // --- END UPDATE ---

        function renderCashFlowTrendChart() {
            let data = getFilteredExpenses(); // This now includes 'PG Rent'

            data = data.filter(e => e.category !== 'Rent' && e.category !== 'PG Rent' && e.category !== 'RENT' && e.category !== 'rent');     //-------imp code update for removing the data of rent from graph------

            let labels = [], dataPoints = [];
            if (data.length === 0) {
                createChart('cashFlowTrendChart', 'line', { labels: [], datasets: [] }, { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, title: { display: true, text: 'Cash Flow Trend', color: '#FFFFFF' } } });
                return;
            }

            const [year, monthVal] = chartPeriod.value.split('-').map(Number);
            const monthIndex = monthVal - 1;
            const daysInMonth = new Date(year, monthVal, 0).getDate();

            labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const monthlyData = {};
            labels.forEach(day => monthlyData[day] = 0);

            data.forEach(tx => {
                const d = new Date(tx.date);
                monthlyData[d.getDate()] += Number(tx.amount);
            });
            dataPoints = Object.values(monthlyData);

            const canvas = document.getElementById('cashFlowTrendChart');
            if (!canvas) return; // --- FIX: Check canvas ---
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(110, 231, 183, 0.5)');
            gradient.addColorStop(1, 'rgba(110, 231, 183, 0.05)');
            createChart('cashFlowTrendChart', 'line', { labels, datasets: [{ label: 'Spend Trend', data: dataPoints, borderColor: '#6ee7b7', backgroundColor: gradient, fill: true, tension: 0.3, borderWidth: 2 }] }, { responsive: true, maintainAspectRatio: false, plugins: { ...chartDefaultOptions.plugins, title: { display: true, text: 'Daily Spend (Selected Month)                                                                                     (Note: We are not including the RENT related things in this graph for better graph UI)', color: '#FFFFFF' } }, scales: chartDefaultOptions.scales });
        }

        function generateSmartInsights() {
            const insightsContainer = document.getElementById('smart-insights');
            const now = new Date(), currentMonth = now.getMonth(), currentYear = now.getFullYear();
            const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            const prevMonthDate = new Date(currentYear, currentMonth - 1, 1);
            const prevMonth = prevMonthDate.getMonth(), prevYear = prevMonthDate.getFullYear();

            // --- UPDATE: 'PG Rent' is now included ---
            const analysisExpenses = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.category !== EXCLUDE_CATEGORY)
                : expenses;

            const currentMonthExpenses = analysisExpenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === currentYear && d.getMonth() === currentMonth; });
            const prevMonthExpenses = analysisExpenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === prevYear && d.getMonth() === prevMonth; });
            const currentMonthSavings = savings.filter(s => s.monthKey === currentMonthKey);

            let insights = [];
            const totalSaved = currentMonthSavings.reduce((s, e) => s + Number(e.amount), 0);
            if (totalSaved > 0) {
                insights.push(`<p class="positive">You've set aside ${numberFormat(totalSaved)} in savings this month. Great job!</p>`);
            } else {
                insights.push(`<p class="info">Don't forget to add your savings for this month.</p>`);
            }

            const totalCurrentSpent = currentMonthExpenses.reduce((s, e) => s + Number(e.amount), 0);
            const currentIncome = monthlyIncomes[currentMonthKey] || 0;
            if (currentIncome > 0) {
                const percentSpent = Math.round(((totalCurrentSpent + totalSaved) / currentIncome) * 100);
                if (percentSpent > 100) {
                    insights.push(`<p class="negative">You've used ${percentSpent}% of your income. Be careful!</p>`);
                } else if (percentSpent > 0) {
                    insights.push(`<p class="info">You've used ${percentSpent}% of your monthly income (including savings).</p>`);
                }
            }

            if (currentMonthExpenses.length > 0) {
                const currentCategoryTotals = currentMonthExpenses.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
                const topCategory = Object.entries(currentCategoryTotals).sort((a, b) => b[1] - a[1])[0];
                insights.push(`<p class="info">Your top expense this month is <strong>${escapeHtml(topCategory[0])}</strong> at ${numberFormat(topCategory[1])}.</p>`);
            }

            const totalPrevSpent = prevMonthExpenses.reduce((s, e) => s + Number(e.amount), 0);
            if (totalPrevSpent > 0 && totalCurrentSpent > 0) {
                const totalPercentChange = Math.round(((totalCurrentSpent - totalPrevSpent) / totalPrevSpent) * 100);
                if (totalPercentChange > 10) insights.unshift(`<p class="negative">Overall spending is up by ${totalPercentChange}% from last month.</p>`);
                else if (totalPercentChange < -10) insights.unshift(`<p class="positive">Great job! Spending is down by ${-totalPercentChange}% from last month.</p>`);
                else insights.push(`<p class="info">Your spending is stable compared to last month.</p>`);
            }

            // --- NEW: Add insight for pending returns ---
            const totalPendingReturns = returns.reduce((sum, r) => sum + Number(r.amount), 0);
            if (totalPendingReturns > 0) {
                insights.push(`<p class="info">You have <strong>${numberFormat(totalPendingReturns)}</strong> in pending returns.</p>`);
            }

            // --- NEW: Add insight for pending payables ---
            const totalPendingPayables = payables.reduce((sum, p) => sum + Number(p.amount), 0);
            if (totalPendingPayables > 0) {
                insights.push(`<p class="info">You have <strong>${numberFormat(totalPendingPayables)}</strong> in upcoming payables.</p>`);
            }

            insightsContainer.innerHTML = insights.length > 0 ? insights.slice(0, 3).join('') : '<p class="subtitle">Add transactions to see insights.</p>';
        }

        // --- Data Export & PDF Report Generation ---
        function generatePdfReport(dataToExport, filename, periodTitle) {
            document.body.style.cursor = 'wait';
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("Report generation library not loaded. Please refresh.");
                document.body.style.cursor = 'default';
                return;
            }

            const doc = new jsPDF();
            const user = sessionStorage.getItem(SESSION_KEY) || 'User';
            const capitalizedUser = user.charAt(0).toUpperCase() + user.slice(1);
            const totalPagesExp = '{total_pages_count_string}';

            const header = (data) => {
                doc.setFontSize(20); doc.setTextColor(40); doc.setFont('helvetica', 'bold');
                doc.text('TALYEXP', 15, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.setFont('helvetica', 'normal');
                doc.text(`Expense Report for ${capitalizedUser}`, 15, 26);
                doc.text(`Period: ${periodTitle}`, doc.internal.pageSize.getWidth() - 15, 20, { align: 'right' });
                doc.text(`Generated: ${new Date().toLocaleDateString('en-GB')}`, doc.internal.pageSize.getWidth() - 15, 26, { align: 'right' });
                doc.setLineWidth(0.5); doc.line(15, 30, doc.internal.pageSize.getWidth() - 15, 30);
            };

            const footer = (data) => {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(8); doc.setTextColor(150);
                doc.text(`Page ${data.pageNumber} of ${totalPagesExp}`, doc.internal.pageSize.getWidth() / 2, 287, { align: 'center' });
                doc.text('TALYEXP | Confidential', 15, 287);
            };

            const total = dataToExport.reduce((sum, item) => sum + Number(item.amount), 0);
            const count = dataToExport.length;
            const average = count > 0 ? total / count : 0;
            const categoryTotals = dataToExport.reduce((acc, { category, amount }) => {
                acc[category] = (acc[category] || 0) + Number(amount); return acc;
            }, {});
            const topCategory = Object.keys(categoryTotals).length > 0 ? Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0] : ['N/A', 0];

            const summaryY = 40;
            doc.setFillColor(245, 245, 245);
            doc.roundedRect(14, summaryY, doc.internal.pageSize.getWidth() - 28, 25, 3, 3, 'F');
            doc.setFontSize(10); doc.setTextColor(50);
            doc.text(`Total Expenses:`, 20, summaryY + 7);
            doc.text(`Total Transactions:`, 20, summaryY + 14);
            doc.text(`Average Transaction:`, doc.internal.pageSize.getWidth() / 2, summaryY + 7);
            doc.text(`Top Category:`, doc.internal.pageSize.getWidth() / 2, summaryY + 14);
            doc.setFont('helvetica', 'bold');
            doc.text(numberFormat(total), 60, summaryY + 7);
            doc.text(String(count), 60, summaryY + 14);
            doc.text(numberFormat(average), doc.internal.pageSize.getWidth() / 2 + 40, summaryY + 7);
            doc.text(`${topCategory[0]} (${numberFormat(topCategory[1])})`, doc.internal.pageSize.getWidth() / 2 + 40, summaryY + 14);

            doc.autoTable({
                head: [['Date', 'Title', 'Category', 'Amount (INR)']],
                body: dataToExport.map(item => [formatDate(item.date), item.title, item.category, Number(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })]),
                startY: summaryY + 30,
                margin: { top: 35 },
                didDrawPage: (data) => { header(data); footer(data); },
                headStyles: { fillColor: [41, 128, 186], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 248, 255] },
                styles: { halign: 'left', cellPadding: 2.5 },
                columnStyles: { 3: { halign: 'right' } }
            });

            if (typeof doc.putTotalPages === 'function') {
                doc.putTotalPages(totalPagesExp);
            }

            doc.save(filename);
            document.body.style.cursor = 'default';
        }

        function handleDownload() {
            const period = downloadPeriod.value;
            if (!period.match(/^\d{4}-\d{2}$/)) { alert("Please select a valid month."); return; }
            const [year, monthVal] = period.split('-').map(Number);
            const monthIndex = monthVal - 1;

            // --- UPDATE: 'PG Rent' is now included in downloads ---
            const dataToExport = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === year && d.getMonth() === monthIndex && e.category !== EXCLUDE_CATEGORY; })
                : expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === year && d.getMonth() === monthIndex; });

            const periodTitle = new Date(year, monthIndex, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
            if (dataToExport.length === 0) { alert(`No data available for ${periodTitle}.`); return; }
            generatePdfReport(dataToExport, `TALYEXP_${periodTitle.replace(' ', '_')}.pdf`, periodTitle);
        }

        function handleYearlyDownload() {
            const year = prompt("Enter year for report:", new Date().getFullYear());
            if (!year || isNaN(year)) { alert("Invalid year."); return; }
            // --- UPDATE: 'PG Rent' is now included in downloads ---
            const data = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => new Date(e.date).getFullYear() === parseInt(year) && e.category !== EXCLUDE_CATEGORY)
                : expenses.filter(e => new Date(e.date).getFullYear() === parseInt(year));

            if (data.length === 0) { alert(`No data for the year ${year}.`); return; }
            generatePdfReport(data, `talyexp_yearly_${year}.pdf`, `Year ${year}`);
        }

        function handleQuarterlyDownload() {
            const year = prompt("Enter year for report:", new Date().getFullYear());
            if (!year || isNaN(year)) { alert("Invalid year."); return; }
            const quarter = prompt("Enter quarter (1-4):");
            if (!quarter || !['1', '2', '3', '4'].includes(quarter)) { alert("Invalid quarter."); return; }
            const q = parseInt(quarter), startMonth = (q - 1) * 3, endMonth = startMonth + 2;

            // --- UPDATE: 'PG Rent' is now included in downloads ---
            const data = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === parseInt(year) && d.getMonth() >= startMonth && d.getMonth() <= endMonth && e.category !== EXCLUDE_CATEGORY; })
                : expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === parseInt(year) && d.getMonth() >= startMonth && d.getMonth() <= endMonth; });

            if (data.length === 0) { alert(`No data for Q${q} ${year}.`); return; }
            generatePdfReport(data, `talyexp_quarterly_Q${q}-${year}.pdf`, `Quarter ${q}, ${year}`);
        }

        // --- Data Reset ---
        function checkYearReset() {
            // --- UPDATE: 1-Year Reset functionality is now disabled ---
            return false;
            // const oneYear = 31536000000; // Original value
            // if (meta.startTs && (Date.now() - meta.startTs) >= oneYear) { resetModal.style.display = 'flex'; return true; }
            // return false;
        }

        async function handleFullReset() {
            if (confirm('DANGER! This will permanently delete all your data (expenses, savings, returns, and payables). Are you sure?')) {
                const password = prompt("To confirm this action, please enter your login password:");
                if (!password) { alert("Password not entered. Reset cancelled."); return; }
                const user = sessionStorage.getItem(SESSION_KEY);
                if (!user) { alert('No user session found. Please log in again.'); return; }
                try {
                    const verifyRes = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, password: password })
                    });
                    if (!verifyRes.ok) { alert('Invalid credentials. Cannot reset.'); return; }
                    alert("Password confirmed. Proceeding with data reset.");
                    // --- NEW: Add payables delete ---
                    const [expRes, incRes, saveRes, retRes, payRes, metaRes] = await Promise.all([
                        fetch(`/api/expenses/user/${user}`, { method: 'DELETE' }),
                        fetch(`/api/income/user/${user}`, { method: 'DELETE' }),
                        fetch(`/api/savings/user/${user}`, { method: 'DELETE' }),
                        fetch(`/api/returns/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                        fetch(`/api/payables/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                        fetch('/api/meta/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user }) })
                    ]);
                    if (!expRes.ok || !incRes.ok || !saveRes.ok || !retRes.ok || !payRes.ok || !metaRes.ok) { // --- NEW ---
                        throw new Error(`Reset failed on the server after password verification.`);
                    }
                    alert('All your application data has been reset successfully.');
                    location.reload();
                } catch (err) {
                    console.error("Reset error:", err);
                    alert(`An error occurred during reset. Please try again.`);
                }
            }
        }

        // --- UPDATE: This function is no longer called by any button ---
        /*
        function handleArchiveAndReset() {
            const user = sessionStorage.getItem(SESSION_KEY);
            if (!user) { alert('No user in session'); return; }
            // Note: Archive only includes expenses.
            generatePdfReport(expenses, `talyexp_full_archive_${new Date().toISOString().slice(0, 10)}.pdf`, "Full Data Archive").then(() => {
                Promise.all([
                    fetch(`/api/expenses/user/${user}`, { method: 'DELETE' }),
                    fetch(`/api/income/user/${user}`, { method: 'DELETE' }),
                    fetch(`/api/savings/user/${user}`, { method: 'DELETE' }),
                    fetch(`/api/returns/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                    fetch(`/api/payables/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                    fetch('/api/meta/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user }) })
                ]).then(async ([a, b, c, d, e, f]) => { // --- NEW ---
                    if (!a.ok || !b.ok || !c.ok || !d.ok || !e.ok || !f.ok) throw new Error('Reset failed after archive.');
                    alert('Archive downloaded and all data has been reset.');
                    location.reload();
                }).catch(err => alert(err.message));
            });
        }
        */

        // --- Voice Input Logic ---
        function setupVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { voiceBtn.style.display = 'none'; return; }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            voiceBtn.addEventListener('click', () => { voiceBtn.classList.add('active'); recognition.start(); });
            recognition.onresult = (event) => parseVoiceCommand(event.results[0][0].transcript.toLowerCase());
            recognition.onspeechend = () => recognition.stop();
            recognition.onerror = (event) => console.error('Speech recognition error:', event.error);
            recognition.onend = () => voiceBtn.classList.remove('active');
        }

        function parseVoiceCommand(command) {
            const amountMatch = command.match(/(?:amount|spend|cost)\s+([\d,.]+)/);
            if (amountMatch) amountEl.value = amountMatch[1].replace(/,/g, '');
            const categories = ['food', 'transport', 'bills', 'shopping', 'entertainment', 'health', 'other'];
            const categoryMatch = command.match(/category\s+([a-zA-Z]+)/);
            let category = '';
            if (categoryMatch && categories.includes(categoryMatch[1])) category = categoryMatch[1];
            else { for (const cat of categories) { if (command.includes(cat)) { category = cat; break; } } }
            if (category) categoryEl.value = category.charAt(0).toUpperCase() + category.slice(1);
            const titleMatch = command.match(/title\s+(.+?)(?=\s+amount|\s+category|$)/);
            if (titleMatch) titleEl.value = titleMatch[1].trim().charAt(0).toUpperCase() + titleMatch[1].trim().slice(1);
            if (command.includes('today')) dateEl.value = new Date().toISOString().slice(0, 10);
            else if (command.includes('yesterday')) {
                const d = new Date(); d.setDate(d.getDate() - 1);
                dateEl.value = d.toISOString().slice(0, 10);
            }
            if (command.match(/submit|add|save/) && titleEl.value && amountEl.value) addBtn.click();
        }

        // --- Calculator Logic ---
        function setupCalculator() {
            const display = document.getElementById('calc-display');
            const keysContainer = document.querySelector('.calc-keys');
            let expression = '';
            if (!display || !keysContainer) return;
            keysContainer.addEventListener('click', (event) => {
                const key = event.target.closest('.calc-key');
                if (!key) return;
                const keyValue = key.dataset.key;
                if (keyValue === 'clear') expression = '';
                else if (keyValue === '=') {
                    try {
                        if (/^[0-9+\-*/.() ]+$/.test(expression)) expression = String(eval(expression));
                        else expression = 'Error';
                    } catch { expression = 'Error'; }
                } else {
                    if (expression === 'Error') expression = '';
                    expression += keyValue;
                }
                display.textContent = expression || '0';
            });
        }

        function populateMonthDropdowns() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonthKey = `${currentYear}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            [downloadPeriod, chartPeriod].forEach(dropdown => {
                dropdown.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const monthName = months[i];
                    const monthKey = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = `${monthName} ${currentYear}`;
                    dropdown.appendChild(option);
                }
            });
            chartPeriod.value = currentMonthKey;
            downloadPeriod.value = currentMonthKey;
        }

        // --- App Initialization ---
        function init() {
            dateEl.value = new Date().toISOString().slice(0, 10);
            returnDateEl.value = new Date().toISOString().slice(0, 10); // --- NEW ---
            payableDateEl.value = new Date().toISOString().slice(0, 10); // --- NEW ---
            savingMonthEl.value = new Date().toISOString().slice(0, 7);
            populateMonthDropdowns();

            authBtn.addEventListener('click', handleAuth);
            loginPassEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAuth(); });
            confirmPassEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAuth(); }); // --- UPDATE ---

            // --- FIX for auth toggle link ---
            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthMode(authMode === 'login' ? 'register' : 'login');
            });
            forgotPassLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthMode('reset');
            });

            logoutBtn.addEventListener('click', handleLogout);
            fullResetBtn.addEventListener('click', handleFullReset);
            homeBtn.addEventListener('click', () => showView('home'));
            txBtn.addEventListener('click', () => showView('transactions'));
            savingsBtn.addEventListener('click', () => showView('savings'));
            returnsBtn.addEventListener('click', () => showView('returns')); // --- NEW ---
            payablesBtn.addEventListener('click', () => showView('payables')); // üëà ADDED
            chartPeriod.addEventListener('change', renderAllCharts);
            dateEl.addEventListener('change', renderIncomeForSelectedMonth);

            hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); navLinks.classList.toggle('active'); });
            document.addEventListener('click', (e) => { if (!navLinks.contains(e.target) && !hamburgerBtn.contains(e.target)) navLinks.classList.remove('active'); });

            // --- NEW: Form Toggle Logic ---
            toggleReturnBtn.addEventListener('click', () => {
                returnFormContainer.style.display = 'block';
                payableFormContainer.style.display = 'none';
                toggleReturnBtn.classList.add('active');
                togglePayableBtn.classList.remove('active');
            });
            togglePayableBtn.addEventListener('click', () => {
                returnFormContainer.style.display = 'none';
                payableFormContainer.style.display = 'block';
                toggleReturnBtn.classList.remove('active');
                togglePayableBtn.classList.add('active');
            });

            addBtn.addEventListener('click', async () => {
                const t = titleEl.value.trim(), a = parseFloat(amountEl.value || 0), d = dateEl.value, c = categoryEl.value.trim() || 'Other';
                if (!t || !a || !d) { alert('Please enter title, amount, and date.'); return; }
                try {
                    const res = await fetch('/api/expenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), title: t, amount: a, date: d, category: c })
                    });
                    if (!res.ok) throw new Error('Failed to add expense');
                    await loadDataAndRender();
                    resetForm();
                } catch (err) { alert(err.message); }
            });

            addSavingBtn.addEventListener('click', async () => {
                const t = savingTitleEl.value.trim(), a = parseFloat(savingAmountEl.value || 0), m = savingMonthEl.value;
                if (!t || !a || !m) { alert('Please enter title, amount, and month for saving.'); return; }
                try {
                    const res = await fetch('/api/savings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), title: t, amount: a, monthKey: m })
                    });
                    if (!res.ok) throw new Error('Failed to add saving');
                    await loadDataAndRender();
                    savingTitleEl.value = '';
                    savingAmountEl.value = '';
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Add Return ---
            addReturnBtn.addEventListener('click', async () => {
                const p = returnPersonEl.value.trim(), a = parseFloat(returnAmountEl.value || 0), d = returnDateEl.value, m = returnModeEl.value.trim() || 'N/A';
                if (!p || !a || !d) { alert('Please enter person name, amount, and date.'); return; }
                try {
                    const res = await fetch('/api/returns', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to add pending return');
                    await loadDataAndRender();
                    resetReturnForm();
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Add Payable ---
            addPayableBtn.addEventListener('click', async () => {
                const p = payablePersonEl.value.trim(), a = parseFloat(payableAmountEl.value || 0), d = payableDateEl.value, m = payableModeEl.value.trim() || 'N/A';
                if (!p || !a || !d) { alert('Please enter person name, amount, and due date.'); return; }
                try {
                    const res = await fetch('/api/payables', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to add payable');
                    await loadDataAndRender(); // Reloads all data, including payables
                    resetPayableForm();
                    alert('Payable added successfully!');
                } catch (err) { alert(err.message); }
            });

            updateBtn.addEventListener('click', async () => {
                const t = titleEl.value.trim(), a = parseFloat(amountEl.value || 0), d = dateEl.value, c = categoryEl.value.trim() || 'Other';
                if (!t || !a || !d || !editingId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/expenses/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: t, amount: a, date: d, category: c })
                    });
                    if (!res.ok) throw new Error('Failed to update expense');
                    await loadDataAndRender();
                    resetForm();
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Update Return ---
            updateReturnBtn.addEventListener('click', async () => {
                const p = returnPersonEl.value.trim(), a = parseFloat(returnAmountEl.value || 0), d = returnDateEl.value, m = returnModeEl.value.trim() || 'N/A';
                if (!p || !a || !d || !editingReturnId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/returns/${editingReturnId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to update pending return');
                    await loadDataAndRender();
                    resetReturnForm();
                    if (returnsView.style.display === 'block') renderReturns(); // Refresh view
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Update Payable ---
            updatePayableBtn.addEventListener('click', async () => {
                const p = payablePersonEl.value.trim(), a = parseFloat(payableAmountEl.value || 0), d = payableDateEl.value, m = payableModeEl.value.trim() || 'N/A';
                if (!p || !a || !d || !editingPayableId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/payables/${editingPayableId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to update payable');
                    await loadDataAndRender();
                    resetPayableForm();
                    if (payablesView.style.display === 'block') renderPayables(); // Refresh view
                } catch (err) { alert(err.message); }
            });

            resetBtn.addEventListener('click', resetForm);
            txSearch.addEventListener('input', renderTransactions);
            returnsSearch.addEventListener('input', renderReturns); // --- NEW ---
            payablesSearch.addEventListener('input', renderPayables); // üëà ADDED

            saveIncomeBtn.addEventListener('click', async () => {
                const selectedDateStr = dateEl.value;
                if (!selectedDateStr) { alert('Please select a date.'); return; }
                const monthKey = selectedDateStr.slice(0, 7);
                const incomeValue = Number(monthlyIncomeEl.value || 0);
                try {
                    const res = await fetch('/api/income', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), monthKey, income: incomeValue })
                    });
                    if (!res.ok) throw new Error('Failed to save income');
                    monthlyIncomes[monthKey] = incomeValue;
                    renderIncomeForSelectedMonth();
                    renderAllCharts();
                    alert(`Income saved for ${new Date(monthKey + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}.`);
                } catch (err) { alert(err.message); }
            });

            downloadBtn.addEventListener('click', handleDownload);
            // --- UPDATE: Event listener for 1-year reset button removed ---
            // downloadArchiveBtn.addEventListener('click', handleArchiveAndReset);
            closeModalBtn.addEventListener('click', () => txModal.style.display = 'none');
            txModal.addEventListener('click', (e) => { if (e.target === txModal) txModal.style.display = 'none'; });
            downloadYearlyBtn.addEventListener('click', handleYearlyDownload);
            downloadQuarterlyBtn.addEventListener('click', handleQuarterlyDownload);
            calculatorBtn.addEventListener('click', () => { calculatorModal.style.display = 'flex'; });
            calculatorModal.addEventListener('click', (e) => { if (e.target === calculatorModal) calculatorModal.style.display = 'none'; });

            setupCalculator();
            setupVoiceInput();

            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(async () => {
                    splashScreen.style.display = 'none';
                    if (isLoggedIn()) {
                        appContainer.style.display = 'flex';
                        await loadDataAndRender();
                    } else {
                        loginScreen.style.display = 'flex';
                    }
                }, 500);
            }, 1500);
        }

        init();
    </script>

</body>

</html>
