<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="spending.png" />
    <title>TALYEXP - Expense Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="TALYEXP.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

</head>

<body>
    <div id="splash-screen">
        <div><img class="splash-logo" src="spending.png" alt="TX"></div>
        <div class="splash-title">TALYEXP</div>
    </div>

    <div id="login-screen" class="login-screen" style="display:none">
        <div class="login-box">
            <div><img class="login-logo" src="spending.png" alt="TX"></div>
            <h2 id="auth-title">Welcome to talyexp</h2>
            <p id="auth-subtitle">Enter your credentials to access your dashboard</p>
            <div class="input-group">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.84,8c18.84-32.56,52.14-52,89.08-52s70.24,19.44,89.08,52a8,8,0,1,0,13.84-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z">
                        </path>
                    </svg></span>
                <input id="loginUser" class="input" placeholder="Username" />
            </div>
            <div class="input-group" id="pass-group">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96v96a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Zm-80,84a12,12,0,1,1,12-12A12,12,0,0,1,128,164Zm32-84H96V56a32,32,0,0,1,64,0Z">
                        </path>
                    </svg></span>
                <input id="loginPass" class="input" placeholder="Password" type="password" />
            </div>
            <div id="confirm-pass-group" class="input-group" style="display: none;">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96v96a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Zm-80,84a12,12,0,1,1,12-12A12,12,0,0,1,128,164Zm32-84H96V56a32,32,0,0,1,64,0Z">
                        </path>
                    </svg></span>
                <input id="confirmPass" class="input" placeholder="Confirm Password" type="password" />
            </div>
            <button id="authBtn" class="login-btn">Secure Sign In</button>
            <div class="auth-toggle">
                <span id="auth-toggle-text">Don't have an account?</span>
                <a id="auth-toggle-link">Sign Up</a>
            </div>
            <div class="auth-toggle" style="margin-top: 10px;">
                <a id="forgot-pass-link">Forgot Password?</a>
            </div>
        </div>
    </div>

    <div class="app-wrap" id="app-container">
        <header class="card">
            <div class="brand">
                <div><img class="logo" src="spending.png" alt="TX"></div>
                <div>
                    <h1>TALYEXP</h1>
                    <div id="user-greeting" class="subtitle"></div>
                </div>
            </div>

            <div class="header-right">
                <div class="top-actions" style="display:flex; gap: 8px; align-items:center;">
                    <select id="downloadPeriod" class="search-input small" style="width: 140px;"></select>
                    <button id="downloadBtn" class="btn small">Download Report</button>
                </div>
                <nav class="main-nav">
                    <button id="hamburger-btn" style="font-size: 28px; background: none; border: none; cursor: pointer;"
                        title="Take a bite!">
                        üçî
                    </button>

                    <!-- UPDATED: Navbar structure -->
                    <div id="nav-links">
                        <button id="homeBtn" class="btn small active">Home</button>
                        <button id="txBtn" class="btn small ghost">Transactions</button>
                        <button id="savingsBtn" class="btn small ghost">Savings</button>
                        <button id="returnsBtn" class="btn small ghost">Returns (To be taken)</button>
                        <button id="payablesBtn" class="btn small ghost">Payables (To be Returned)</button>
                        <button id="notesBtn" class="btn small ghost">Notes</button>
                        <button id="themeToggleBtn" class="btn ghost small" title="Toggle Theme"
                            style="padding: 6px 8px;">
                            ‚òÄÔ∏è / üåô
                        </button>

                        <!-- NEW: Settings Container -->
                        <div class="settings-container">
                            <button id="settingsBtn" class="btn ghost small">settings</button>
                            <div id="settings-popout">
                                <button id="contactBtn" class="btn small ghost">Contact Me</button>
                                <button id="calculatorBtn" class="btn ghost small" title="Calculator"
                                    style="padding: 6px 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        viewBox="0 0 256 256">
                                        <path
                                            d="M184,32H72A16,16,0,0,0,56,48V208a16,16,0,0,0,16,16H184a16,16,0,0,0,16-16V48A16,16,0,0,0,184,32Zm0,176H72V48H184ZM128,80a12,12,0,1,1-12,12A12,12,0,0,1,128,80Zm36,28a12,12,0,1,1-12,12A12,12,0,0,1,164,108Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,128,108Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,92,108Zm72,36a12,12,0,1,1-12,12A12,12,0,0,1,164,144Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,128,144Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,92,144Zm72,36a12,12,0,1,1-12,12A12,12,0,0,1,164,180Zm-36,0a12,12,0,1,1-12,12A12,12,0,0,1,128,180Z">
                                        </path>
                                    </svg>
                                    <div class="calcbtn">Calculator</div>
                                </button>
                                <button id="fullResetBtn" class="btn small danger">Reset App</button>
                                <button id="deleteAccountBtn" class="btn small danger">Delete Account</button>
                                <button id="logoutBtn" class="btn ghost small">Logout</button>
                            </div>
                        </div>
                        <!-- END: Settings Container -->

                    </div>
                    <!-- END: Updated Navbar -->
                </nav>
            </div>
        </header>

        <main>
            <div id="home-view">
                <div class="app-grid">
                    <section class="left-column">
                        <div class="card" style="flex-shrink: 0;">
                            <h3 style="margin-top:0; color: var(--accent);">Smart Insights</h3>
                            <div id="smart-insights">
                                <p class="subtitle">Add more transactions to see smart suggestions.</p>
                            </div>
                        </div>
                        <div class="card" style="flex-grow: 1;">
                            <div style="display:flex; justify-content: space-between; align-items: center;">
                                <label for="monthlyIncome">Monthly Income (for selected month)</label>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center; margin-top: 6px;">
                                <input id="monthlyIncome" class="input" type="number"
                                    placeholder="Income for selected month" />
                                <button id="saveIncome" class="btn small">Save</button>
                            </div>
                            <div style="margin-top:8px" class="subtitle">Remaining this month: <strong
                                    id="remaining">‚Çπ0.00</strong></div>
                        </div>
                        <div class="card" style="flex-shrink: 0;">
                            <div>
                                <h4>Add your expenses:</h4>
                                <label for="title">Title (Expense)</label>
                                <input id="title" class="input" type="text" placeholder="e.g., Dinner with friends" />
                            </div>
                            <div class="form-row" style="margin-top: 14px;">
                                <div style="flex:1"><label for="amount">Amount (‚Çπ)</label><input id="amount"
                                        class="input" type="number" placeholder="0.00" /></div>
                                <div style="width:150px"><label for="date">Date</label><input id="date" class="input"
                                        type="date" /></div>
                            </div>
                            <div style="margin-top: 14px;">
                                <label for="category">Category</label>
                                <input id="category" type="text" class="input"
                                    placeholder="e.g., Food, Transport, Bills" />
                            </div>
                            <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                <button id="addBtn" class="btn">Add Expense</button>
                                <button id="voiceBtn" class="btn ghost" title="Add with Voice"
                                    style="padding: 8px 12px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        viewBox="0 0 256 256">
                                        <path
                                            d="M128,176a48.05,48.05,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48.05,48.05,0,0,0,128,176ZM96,64a32,32,0,0,1,64,0v64a32,32,0,0,1-64,0Zm40,151.6V240a8,8,0,0,1-16,0V215.6A80.05,80.05,0,0,1,48,128a8,8,0,0,1,16,0,64,64,0,0,0,128,0,8,8,0,0,1,16,0A80.05,80.05,0,0,1,136,215.6Z">
                                        </path>
                                    </svg>
                                </button>
                                <button id="updateBtn" class="btn ghost" style="display:none">Update</button>
                                <button id="resetBtn" class="btn ghost">Reset</button>
                            </div>
                        </div>

                        <div class="card" style="flex-shrink: 0;">
                            <div>
                                <h4>Add your savings for the current month:</h4>
                                <label for="saving-title">Title (Saving)</label>
                                <input id="saving-title" class="input" type="text" placeholder="e.g., Mutual Fund" />
                            </div>
                            <div class="form-row" style="margin-top: 14px;">
                                <div style="flex:1"><label for="saving-amount">Amount (‚Çπ)</label><input
                                        id="saving-amount" class="input" type="number" placeholder="0.00" /></div>
                                <div style="width:150px"><label for="saving-month">Month</label><input id="saving-month"
                                        class="input" type="month" /></div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                <button id="addSavingBtn" class="btn">Add Saving</button>
                                <button id="updateSavingBtn" class="btn ghost" style="display:none">Update
                                    Saving</button>
                            </div>
                        </div>

                        <div class="card" style="flex-shrink: 0;">
                            <div
                                style="display: flex; gap: -1px; border-bottom: 1px solid var(--glass); margin-bottom: 16px;">
                                <button id="toggle-return-form" class="btn form-toggle-btn active">Lent
                                    (Returns)</button>
                                <button id="toggle-payable-form" class="btn form-toggle-btn">To Pay (Payables)</button>
                            </div>

                            <div id="return-form-container">
                                <h4>Add details of amount you have given to:</h4>
                                <label for="return-person">Person's Name (Money given to)</label>
                                <input id="return-person" class="input" type="text" placeholder="e.g., John Doe" />
                                <div class="form-row" style="margin-top: 14px;">
                                    <div style="flex:1">
                                        <label for="return-amount">Amount (‚Çπ)</label>
                                        <input id="return-amount" class="input" type="number" placeholder="0.00" />
                                    </div>
                                    <div style="width:150px">
                                        <label for="return-date">Date Given</label>
                                        <input id="return-date" class="input" type="date" />
                                    </div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label for="return-mode">Payment Mode</label>
                                    <input id="return-mode" type="text" class="input" placeholder="e.g., UPI, Cash" />
                                </div>
                                <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                    <button id="addReturnBtn" class="btn">Add Return</button>
                                    <button id="updateReturnBtn" class="btn ghost" style="display:none">Update
                                        Return</button>
                                </div>
                            </div>

                            <div id="payable-form-container" style="display: none;">
                                <h4>Add details of amount to whome to be paid:</h4>
                                <label for="payable-person">Person's Name (Money to be given to)</label>
                                <input id="payable-person" class="input" type="text" placeholder="e.g., Jane Smith" />
                                <div class="form-row" style="margin-top: 14px;">
                                    <div style="flex:1">
                                        <label for="payable-amount">Amount (‚Çπ)</label>
                                        <input id="payable-amount" class="input" type="number" placeholder="0.00" />
                                    </div>
                                    <div style="width:150px">
                                        <label for="payable-date">Received Date</label>
                                        <input id="payable-date" class="input" type="date" />
                                    </div>
                                </div>
                                <div style="margin-top: 14px;">
                                    <label for="payable-mode">Payment Mode</label>
                                    <input id="payable-mode" type="text" class="input" placeholder="e.g., UPI, Cash" />
                                </div>
                                <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                                    <button id="addPayableBtn" class="btn">Add Payable</button>
                                    <button id="updatePayableBtn" class="btn ghost" style="display:none">Update
                                        Payable</button>
                                </div>
                            </div>
                        </div>
                        <div class="card" style="flex-shrink: 0;">
                            <div class="summary">
                                <div class="stat">
                                    <h3>Total</h3>
                                    <p id="totalAll">‚Çπ0.00</p>
                                </div>
                                <div class="stat">
                                    <h3>This Month</h3>
                                    <p id="totalMonth">‚Çπ0.00</p>
                                </div>
                                <div class="stat">
                                    <h3>Transactions</h3>
                                    <p id="countTx">0</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="right-column">
                        <div class="card" style="flex-grow: 1;">
                            <div
                                style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-bottom:10px;">
                                <label for="chartPeriod" class="subtitle" style="margin:0;">Filter Charts:</label>
                                <select id="chartPeriod" class="search-input small" style="width: 140px;"></select>
                            </div>
                            <div class="charts-grid">
                                <div class="chart-card"><canvas id="monthlyBarChart"></canvas></div>
                                <div class="chart-card"><canvas id="categoryBarChart"></canvas></div>
                                <div class="chart-card"><canvas id="pieChart"></canvas></div>
                                <div class="chart-card"><canvas id="donutChart"></canvas></div>
                                <div class="chart-card"><canvas id="savingsBarChart"></canvas></div>
                                <div class="chart-card"><canvas id="cashFlowOverviewChart"></canvas></div>
                            </div><br>
                            <div class="chart-card"><canvas id="cashFlowTrendChart"></canvas></div>
                        </div>
                    </section>
                </div>
            </div>

            <div id="transactions-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Monthly Overview</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button id="downloadYearlyBtn" class="btn small ghost">Yearly Report</button>
                        <button id="downloadQuarterlyBtn" class="btn small ghost">Quarterly Report</button>
                        <input id="txSearch" class="search-input" placeholder="Search transactions..." />
                    </div>
                </div>

                <div id="txListContainer" class="tx-list-container">
                    <div id="txGrid" class="tx-grid"></div>
                </div>
            </div>

            <div id="savings-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Your Savings</h2>
                </div>
                <div id="savingsListContainer" class="tx-list-container">
                    <div id="savingsGrid" class="tx-grid">
                    </div>
                </div>
            </div>

            <div id="returns-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Pending Returns</h2>
                    <input id="returnsSearch" class="search-input" placeholder="Search by name..." />
                </div>
                <div id="returnsListContainer" class="tx-list-container">
                    <div id="returnsGrid" class="tx-grid">
                    </div>
                </div>
            </div>

            <div id="payables-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Upcoming Payables</h2>
                    <input id="payablesSearch" class="search-input" placeholder="Search by name..." />
                </div>
                <div id="payablesListContainer" class="tx-list-container">
                    <div id="payablesGrid" class="tx-grid">
                    </div>
                </div>
            </div>

            <div id="notes-view" class="card" style="display: none;">
                <div class="top-bar"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0;">Keep Notes</h2>
                    <button id="toggleNoteFormBtn" class="btn small ghost">Hide Form</button>
                </div>

                <div id="note-creation-card" class="note-input-container card" style="margin-bottom: 20px;">
                    <label for="note-title">Note Title</label>
                    <input id="note-title" class="input" type="text" placeholder="e.g., Ideas for next month" />

                    <div style="margin-top: 14px;">
                        <label for="note-content">Note Content</label>
                        <textarea id="note-content" class="input"
                            placeholder="Type or speak your thoughts here..."></textarea>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:16px;align-items:center;">
                        <button id="noteUpdateBtn" class="btn">Update/Save Note</button>
                        <button id="noteResetBtn" class="btn ghost">Reset</button>
                        <button id="noteVoiceBtn" class="btn ghost" title="Add with Voice" style="padding: 8px 12px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                viewBox="0 0 256 256">
                                <path
                                    d="M128,176a48.05,48.05,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48.05,48.05,0,0,0,128,176ZM96,64a32,32,0,0,1,64,0v64a32,32,0,0,1-64,0Zm40,151.6V240a8,8,0,0,1-16,0V215.6A80.05,80.05,0,0,1,48,128a8,8,0,0,1,16,0,64,64,0,0,0,128,0,8,8,0,0,1,16,0A80.05,80.05,0,0,1,136,215.6Z">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>

                <h3>Your Saved Notes</h3>
                <div id="notes-container" class="tx-grid">
                </div>
            </div>
            <div id="contact-view" class="card" style="display: none;">
                <div class="top-bar">
                    <h2 style="margin:0;">Contact Me / Suggestions</h2>
                </div>
                <p class="subtitle" style="margin-top: 0; margin-bottom: 24px;">Have a question or a suggestion to
                    improve TALYEXP? Let me know!</p>

                <form id="contact-form" style="max-width: 600px; margin: 0 auto;">
                    <div style="margin-bottom: 1rem;">
                        <label for="contact-name">Your Name (Required)</label>
                        <input id="contact-name" class="input" type="text" required />
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="contact-phone">Phone Number (Required)</label>
                        <input id="contact-phone" class="input" type="text" required />
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="contact-email">Email (Optional)</label>
                        <input id="contact-email" class="input" type="email" />
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label for="contact-query">Your Query or Suggestion</label>
                        <textarea id="contact-query" class="input"
                            placeholder="Please tell your query or tell any suggestions to improve the application"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn">Submit</button>
                        <button type="reset" class="btn ghost">Reset</button>
                        <button class="btn"><a href="index.html">Back</a></button>
                    </div>
                </form>
            </div>

        </main>
        <footer class="card"
            style="margin-top: 12px; padding: 12px; text-align: center; position: relative; min-height: 60px; display: flex; align-items: center; justify-content: center;">
            <p style="margin:0; font-size: 14px; color: var(--muted);">
                Developed by <strong>PCJ</strong>
                <br> &copy; 2025 TALYEXP. All Rights Reserved.
            </p>
            <div id="about-me-btn-container">
                <button id="aboutMeBtn" class="btn small" title="About Me">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216ZM120,104a8,8,0,0,1,16,0v64a8,8,0,0,1-16,0Zm8-40a12,12,0,1,1-12,12A12,12,0,0,1,128,64Z">
                        </path>
                    </svg>
                </button>
            </div>
        </footer>
    </div>

    <div id="tx-modal" class="tx-modal">
        <div class="tx-modal-content">
            <div class="tx-modal-header">
                <h2 id="tx-modal-title">Month Details</h2>
                <button id="close-modal-btn" class="close-modal-btn">&times;</button>
            </div>
            <div id="tx-modal-body" class="tx-modal-body">
            </div>
        </div>
    </div>

    <div id="calculator-modal" class="reset-modal">
        <div id="calculator">
            <div id="calc-display" class="calc-display">0</div>
            <div class="calc-keys">
                <button class="calc-key calc-key-op" data-key="clear">C</button>
                <button class="calc-key calc-key-op" data-key="/">/</button>
                <button class="calc-key calc-key-op" data-key="*">*</button>
                <button class="calc-key calc-key-op" data-key="-">-</button>
                <button class="calc-key" data-key="7">7</button>
                <button class="calc-key" data-key="8">8</button>
                <button class="calc-key" data-key="9">9</button>
                <button class="calc-key calc-key-op" data-key="+">+</button>
                <button class="calc-key" data-key="4">4</button>
                <button class="calc-key" data-key="5">5</button>
                <button class="calc-key" data-key="6">6</button>
                <button class="calc-key calc-key-equals" data-key="=">=</button>
                <button class="calc-key" data-key="1">1</button>
                <button class="calc-key" data-key="2">2</button>
                <button class="calc-key" data-key="3">3</button>
                <button class="calc-key calc-key-zero" data-key="0">0</button>
                <button class="calc-key" data-key=".">.</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="reset-modal">
        <div class="reset-box">
            <h3 id="password-modal-title">Confirm Action</h3>
            <p id="password-modal-message">To confirm, please enter your login password:</p>
            <div class="input-group" style="margin: 1.5rem 0;">
                <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 256 256">
                        <path
                            d="M208,80H176V56a48,48,0,0,0-96,0V80H48A16,16,0,0,0,32,96v96a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80Zm-80,84a12,12,0,1,1,12-12A12,12,0,0,1,128,164Zm32-84H96V56a32,32,0,0,1,64,0Z">
                        </path>
                    </svg></span>
                <input id="password-modal-input" class="input" type="password" placeholder="Password" />
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="password-modal-cancel" class="btn ghost">Cancel</button>
                <button id="password-modal-confirm" class="btn danger">Confirm</button> <!-- Changed text -->
            </div>
        </div>
    </div>

    <div id="note-view-modal" class="tx-modal">
        <div class="tx-modal-content">
            <div
                style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass); padding-bottom: 10px; margin-bottom: 10px;">
                <h3 id="note-modal-title" style="margin: 0;">Note Title</h3>
                <span class="close-btn" style="cursor: pointer;">&times;</span>
            </div>
            <div id="note-modal-body" class="tx-modal-body" style="max-height: 400px; overflow-y: auto;">
            </div>
        </div>
    </div>

    <div id="about-me-modal" class="tx-modal">
        <div class="tx-modal-content" style="max-width: 500px; text-align: left;">
            <div class="tx-modal-header">
                <h2 id="about-me-modal-title">About Me</h2>
                <button id="close-about-me-modal-btn" class="close-modal-btn">&times;</button>
            </div>
            <div id="about-me-modal-body" class="tx-modal-body" style="max-height: 450px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="image_self.png" alt="PJ"
                        style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent);">
                </div>
                <h3 style="margin-top: 0;">Pranav Javalagi</h3><br>
                <p style="font-size: 14px; color: var(--text-muted); margin-top: -10px; margin-bottom: 20px;">
                    <a href="mailto:pcjavalagi2002@gmail.com" style="color: var(--accent);">pcjavalagi2002@gmail.com</a>
                </p>
                <p style="font-size: 14px; line-height: 1.6;">
                    Feel free to reach out to me for any queries, suggestions, or collaboration opportunities. I am
                    always
                    excited to connect with like-minded individuals and professionals in the tech community.
                    Check out my protfolio: <strong
                        style="color: var(--accent); background: rgba(110, 231, 183, 0.1); padding: 2px 4px; border-radius: 4px;">
                        pranavjportfolio.netlify.app</strong>
                </p>
                <h4>Who am I?</h4>
                <p style="font-size: 14px; line-height: 1.6;">
                    I am a dedicated working professional currently serving as a Systems Engineer at TCS. My passion
                    lies
                    in the ever-evolving world of technology, and I am particularly eager to deepen my expertise in
                    Artificial Intelligence and Machine Learning (AI/ML).
                </p>
                <p style="font-size: 14px; line-height: 1.6;">
                    I am a proactive learner, always seeking new challenges to grow my skills. I am currently <strong
                        style="color: var(--accent); background: rgba(110, 231, 183, 0.1); padding: 2px 4px; border-radius: 4px;">open
                        to work</strong> and excited about opportunities where I can contribute to innovative projects
                    and make a meaningful impact.
                </p>

            </div>
        </div>
    </div>

    <script>
        // --- App State & Constants ---
        const SESSION_KEY = 'talyexp_v1:session';
        // --- UPDATE: Set EXCLUDE_CATEGORY to empty string to include 'PG Rent' in all totals ---
        const EXCLUDE_CATEGORY = ''; // Was 'PG Rent'
        let expenses = [];
        let savings = [];
        let groupedExpenses = {};
        let groupedSavings = {}; // --- UPDATE: Added for new UI ---

        // --- NEW: Pending Returns State ---
        let returns = [];
        let groupedReturns = {};
        let editingReturnId = null;

        // --- NEW: Payables State ---
        let payables = [];
        let editingPayableId = null;

        let meta = { startTs: Date.now() };
        let editingId = null;
        let editingSavingId = null; // üëà ADDED for saving update
        let monthlyIncomes = {};
        let chartInstances = {};
        let authMode = 'login'; // --- UPDATE: 'login', 'register', 'reset' ---

        // index.html: Inside <script> tag, near the other global declarations

        let notes = []; // üëà ADD THIS for storing fetched notes

        // ...existing DOM elements...

        // --- NEW: Keep Notes DOM Elements ---
        const notesBtn = document.getElementById('notesBtn'); // üëà ADD THIS LINE
        const notesView = document.getElementById('notes-view'); // üëà ADD THIS LINE
        const noteTitleEl = document.getElementById('note-title');
        const noteContentEl = document.getElementById('note-content');
        const noteUpdateBtn = document.getElementById('noteUpdateBtn');
        const noteResetBtn = document.getElementById('noteResetBtn');
        const noteVoiceBtn = document.getElementById('noteVoiceBtn');
        const notesContainer = document.getElementById('notes-container');
        const noteViewModal = document.getElementById('note-view-modal');
        const noteModalTitle = document.getElementById('note-modal-title');
        const noteModalBody = document.getElementById('note-modal-body');

        let editingNoteId = null; // for future update feature
        // ...

        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash-screen');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const authBtn = document.getElementById('authBtn');
        const logoutBtn = document.getElementById('logoutBtn'); // Now in settings
        const fullResetBtn = document.getElementById('fullResetBtn'); // Now in settings
        const homeBtn = document.getElementById('homeBtn');
        const txBtn = document.getElementById('txBtn');
        const savingsBtn = document.getElementById('savingsBtn');
        const returnsBtn = document.getElementById('returnsBtn'); // --- NEW ---
        const payablesBtn = document.getElementById('payablesBtn'); // üëà ADDED
        const contactBtn = document.getElementById('contactBtn'); // Now in settings
        const themeToggleBtn = document.getElementById('themeToggleBtn'); // --- NEW ---
        const homeView = document.getElementById('home-view');
        const transactionsView = document.getElementById('transactions-view');
        const savingsView = document.getElementById('savings-view');
        const returnsView = document.getElementById('returns-view'); // --- NEW ---
        const payablesView = document.getElementById('payables-view'); // üëà ADDED
        const contactView = document.getElementById('contact-view'); // --- NEW ---

        const titleEl = document.getElementById('title');
        const amountEl = document.getElementById('amount');
        const dateEl = document.getElementById('date');
        const categoryEl = document.getElementById('category');
        const addBtn = document.getElementById('addBtn');
        const updateBtn = document.getElementById('updateBtn');
        const resetBtn = document.getElementById('resetBtn');

        const savingTitleEl = document.getElementById('saving-title');
        const savingAmountEl = document.getElementById('saving-amount');
        const savingMonthEl = document.getElementById('saving-month');
        const addSavingBtn = document.getElementById('addSavingBtn');
        const updateSavingBtn = document.getElementById('updateSavingBtn'); // üëà ADDED
        const savingsGrid = document.getElementById('savingsGrid'); // --- UPDATE ---

        // --- NEW: Pending Return DOM Elements ---
        const returnPersonEl = document.getElementById('return-person');
        const returnAmountEl = document.getElementById('return-amount');
        const returnDateEl = document.getElementById('return-date');
        const returnModeEl = document.getElementById('return-mode');
        const addReturnBtn = document.getElementById('addReturnBtn');
        const updateReturnBtn = document.getElementById('updateReturnBtn');
        const returnsGrid = document.getElementById('returnsGrid');
        const returnsSearch = document.getElementById('returnsSearch');

        // --- NEW: Payable DOM Elements (from new HTML) ---
        const payablePersonEl = document.getElementById('payable-person');
        const payableAmountEl = document.getElementById('payable-amount');
        const payableDateEl = document.getElementById('payable-date');
        const payableModeEl = document.getElementById('payable-mode');
        const addPayableBtn = document.getElementById('addPayableBtn');
        const updatePayableBtn = document.getElementById('updatePayableBtn'); // üëà ADDED
        const toggleReturnBtn = document.getElementById('toggle-return-form');
        const togglePayableBtn = document.getElementById('toggle-payable-form');
        const payablesGrid = document.getElementById('payablesGrid'); // üëà ADDED
        const payablesSearch = document.getElementById('payablesSearch'); // üëà ADDED
        const returnFormContainer = document.getElementById('return-form-container');
        const payableFormContainer = document.getElementById('payable-form-container');

        // --- NEW: Contact Form Elements ---
        const contactForm = document.getElementById('contact-form');
        const contactName = document.getElementById('contact-name');
        const contactPhone = document.getElementById('contact-phone');

        const totalAll = document.getElementById('totalAll');
        const totalMonth = document.getElementById('totalMonth');
        const countTx = document.getElementById('countTx');
        const downloadPeriod = document.getElementById('downloadPeriod');
        const downloadBtn = document.getElementById('downloadBtn');
        const chartPeriod = document.getElementById('chartPeriod');
        const monthlyIncomeEl = document.getElementById('monthlyIncome');
        const saveIncomeBtn = document.getElementById('saveIncome');
        const remainingEl = document.getElementById('remaining');
        const txSearch = document.getElementById('txSearch');
        // const resetModal = document.getElementById('reset-modal'); // --- UPDATE: Modal removed ---
        // const downloadArchiveBtn = document.getElementById('downloadArchiveBtn'); // --- UPDATE: Button removed ---
        const authToggleLink = document.getElementById('auth-toggle-link');
        const forgotPassLink = document.getElementById('forgot-pass-link'); // --- UPDATE ---
        const passGroup = document.getElementById('pass-group'); // --- UPDATE ---
        const confirmPassGroup = document.getElementById('confirm-pass-group');
        const loginUserEl = document.getElementById('loginUser');
        const loginPassEl = document.getElementById('loginPass');
        const confirmPassEl = document.getElementById('confirmPass');
        const txGrid = document.getElementById('txGrid');
        const txModal = document.getElementById('tx-modal');
        const txModalTitle = document.getElementById('tx-modal-title');
        const txModalBody = document.getElementById('tx-modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const downloadYearlyBtn = document.getElementById('downloadYearlyBtn');
        const downloadQuarterlyBtn = document.getElementById('downloadQuarterlyBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const calculatorModal = document.getElementById('calculator-modal');
        const calculatorBtn = document.getElementById('calculatorBtn'); // Now in settings
        const userGreetingEl = document.getElementById('user-greeting');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const navLinks = document.getElementById('nav-links');

        // --- NEW: Password Modal Elements ---
        const passwordModal = document.getElementById('password-modal');
        const passwordModalInput = document.getElementById('password-modal-input');
        const passwordModalConfirm = document.getElementById('password-modal-confirm');
        const passwordModalCancel = document.getElementById('password-modal-cancel');
        const passwordModalTitle = document.getElementById('password-modal-title'); // Get title
        const passwordModalMessage = document.getElementById('password-modal-message'); // Get message

        // --- NEW: About Me Modal Elements ---
        const aboutMeBtn = document.getElementById('aboutMeBtn');
        const aboutMeModal = document.getElementById('about-me-modal');
        const closeAboutMeModalBtn = document.getElementById('close-about-me-modal-btn');


        // --- Utility Functions ---
        const numberFormat = (n) => Number(n).toLocaleString('en-IN', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        const formatDate = (d) => new Date(d).toLocaleDateString('en-GB');


        const escapeHtml = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

        // -------
        // --- NEW: Add this debounce utility function ---
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        // -------

        // --- Authentication ---
        const isLoggedIn = () => !!sessionStorage.getItem(SESSION_KEY);

        function validatePassword(password) {
            if (password.length < 10) { alert(`Password must be at least 10 characters long.`); return false; }
            if (!/[A-Z]/.test(password)) { alert('Password must contain at least one uppercase letter.'); return false; }
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) { alert('Password must contain at least one special character.'); return false; }
            return true;
        }

        async function handleAuth() {
            const username = loginUserEl.value.trim().toLowerCase();
            const password = loginPassEl.value;
            if (!username) {
                alert('Username cannot be empty.');
                return;
            }
            try {
                if (authMode === 'login') {
                    if (!password) { alert('Password cannot be empty.'); return; }
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Invalid credentials');
                    sessionStorage.setItem(SESSION_KEY, username);
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'flex';
                    await loadDataAndRender();
                } else if (authMode === 'register') {
                    const confirmPass = confirmPassEl.value;
                    if (password !== confirmPass) { alert('Passwords do not match.'); return; }
                    if (!validatePassword(password)) return;
                    const res = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Registration failed');
                    alert('Account created successfully! Please sign in.');
                    toggleAuthMode('login');
                } else if (authMode === 'reset') { // --- UPDATE: Handle reset ---
                    const newPassword = confirmPassEl.value;
                    if (!validatePassword(newPassword)) return;
                    if (!confirm('Are you sure you want to reset the password for this user?')) return;
                    const res = await fetch('/api/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, newPassword })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Password reset failed');
                    alert('Password reset successfully! Please sign in with your new password.');
                    toggleAuthMode('login');
                }
            } catch (err) {
                alert(`Authentication Error: ${err.message}`);
            }
        }

        function handleLogout() {
            sessionStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        // --- UPDATE: Toggle auth mode logic ---
        function toggleAuthMode(mode) {
            authMode = mode;
            loginUserEl.value = loginPassEl.value = confirmPassEl.value = '';
            const authTitle = document.getElementById('auth-title');
            const authSubtitle = document.getElementById('auth-subtitle');

            // --- FIX: Use auth-toggle-text and auth-toggle-link ---
            const authToggleText = document.getElementById('auth-toggle-text');
            const authToggleLink = document.getElementById('auth-toggle-link');

            if (authMode === 'login') {
                authTitle.textContent = 'Welcome Back';
                authSubtitle.textContent = 'Enter your credentials to access your dashboard';
                authBtn.textContent = 'Secure Sign In';
                passGroup.style.display = 'block';
                confirmPassGroup.style.display = 'none';
                authToggleText.textContent = "Don't have an account? ";
                authToggleLink.textContent = 'Sign Up';
                forgotPassLink.style.display = 'block';
            } else if (authMode === 'register') {
                authTitle.textContent = 'Create Account';
                authSubtitle.textContent = 'Create a new account to get started';
                authBtn.textContent = 'Sign Up';
                passGroup.style.display = 'block';
                confirmPassGroup.style.display = 'block';
                confirmPassEl.placeholder = "Confirm Password";
                authToggleText.textContent = "Already have an account? ";
                authToggleLink.textContent = 'Sign In';
                forgotPassLink.style.display = 'none';
            } else if (authMode === 'reset') {
                authTitle.textContent = 'Reset Password';
                authSubtitle.textContent = 'Enter username and your new password';
                authBtn.textContent = 'Reset Password';
                passGroup.style.display = 'none';
                confirmPassGroup.style.display = 'block';
                confirmPassEl.placeholder = "Enter New Password";
                authToggleText.textContent = "Remembered your password? ";
                authToggleLink.textContent = 'Sign In';
                forgotPassLink.style.display = 'none';
            }
        }
        // index.html: Inside <script> tag, add these functions (e.g., near other CRUD functions)

        // Helper function to reset the form
        function resetNoteForm() {
            noteTitleEl.value = '';
            noteContentEl.value = '';
            editingNoteId = null;
            noteUpdateBtn.textContent = 'Update/Save Note';
            noteUpdateBtn.classList.remove('ghost');
        }

        // Function to handle saving/updating a note (4. update button creates cards)
        async function handleUpdateNote() {
            const t = noteTitleEl.value.trim();
            const c = noteContentEl.value.trim();

            if (!t || !c) {
                alert('Please enter a title and content for your note.');
                return;
            }

            try {
                const url = editingNoteId ? `/api/notes/${editingNoteId}` : '/api/notes';
                const method = editingNoteId ? 'PUT' : 'POST'; // Assuming you'd implement the PUT route for updates later, POST for new notes. Using POST/Create for simplicity here.

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user: sessionStorage.getItem(SESSION_KEY),
                        title: t,
                        content: c,
                    })
                });

                if (!res.ok) throw new Error(`Failed to ${editingNoteId ? 'update' : 'add'} note`);

                await fetchNotes(); // Re-fetch all notes
                renderNotes();
                resetNoteForm();

            } catch (err) {
                alert(err.message);
            }
        }

        // Function to delete a note
        async function handleDeleteNote(id) {
            if (!confirm('Are you sure you want to delete this note?')) return;
            try {
                const res = await fetch(`/api/notes/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete note');

                await fetchNotes(); // Re-fetch all notes
                renderNotes();
            } catch (err) {
                alert(err.message);
            }
        }

        // Function to show the full note in a modal (4. view button/popup)
        function showNoteModal(id) {
            const note = notes.find(n => n._id === id);
            if (note) {
                noteModalTitle.textContent = escapeHtml(note.title);
                // Use <br> to respect line breaks from the textarea
                noteModalBody.innerHTML = escapeHtml(note.content).replace(/\n/g, '<br>');
                noteViewModal.style.display = 'flex';
            }
        }

        // Function to render the notes as cards (4. cards should create)
        function renderNotes() {
            notesContainer.innerHTML = '';
            if (notes.length === 0) {
                notesContainer.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No notes saved yet.</p>`;
                return;
            }

            // --- NEW: Color array for note cards ---
            const cardColors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5'];

            notes.forEach((note, i) => { // --- NEW: Added index 'i' ---
                // Do not show the whole information in the card
                const snippet = note.content.length > 80 ? `${note.content.substring(0, 80)}...` : note.content;

                // --- NEW: Assign a color class based on index ---
                const colorClass = cardColors[i % cardColors.length];

                const noteCard = document.createElement('div');
                // --- NEW: Added colorClass to the class list ---
                noteCard.className = 'month-card note-card ' + colorClass;
                noteCard.innerHTML = `
            <h3 style="margin-top:0; color: var(--accent);">${escapeHtml(note.title)}</h3>
            <p class="subtitle" style="font-size: 14px; margin: 8px 0; min-height: 40px;">${escapeHtml(snippet)}</p>
            <div style="display: flex; justify-content: space-between; gap: 8px; margin-top: 10px;">
                <button class="btn small" onclick="showNoteModal('${note._id}')" title="View Note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M247.31,124.76c-.35-.79-8.83-19.5-42.84-43.2C172.56,51.84,137.64,32,128,32s-44.56,19.84-76.47,48.47C17.5,105.26,8.23,123.97,8.69,124.76a8,8,0,0,0,0,6.56c.46.79,9.73,19.5,43.74,43.2C83.44,204.16,118.36,224,128,224s44.56-19.84,76.47-48.47C247.31,124.76,247.31,124.76,247.31,124.76ZM128,208c-30.84,0-61.78-14.71-88.75-38.81C28.29,150.7,20.48,137.91,20.06,128c.42-9.92,8.23-22.71,19.19-38.19C66.22,62.71,97.16,48,128,48s61.78,14.71,88.75,38.81C227.71,103.3,235.52,116.09,235.94,128c-.42,9.92-8.23,22.71-19.19,38.19C194.22,193.29,163.28,208,128,208ZM128,80a48,48,0,1,0,48,48A48.05,48.05,0,0,0,128,80Zm0,80a32,32,0,1,1,32-32A32,32,0,0,1,128,160Z"/></svg>
                </button>
                <button class="btn small danger" onclick="handleDeleteNote('${note._id}')" title="Delete Note">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96ZM192,208H64V64H192Zm-96-24V96a8,8,0,0,1,16,0v88a8,8,0,0,1-16,0Zm48,0V96a8,8,0,0,1,16,0v88a8,8,0,0,1-16,0Z"></path>
                    </svg>
                </button>
            </div>
        `;
                notesContainer.appendChild(noteCard);
            });
        }
        // Function to fetch notes (must be added to loadDataAndRender)
        async function fetchNotes() {
            try {
                const res = await fetch(`/api/notes/user/${sessionStorage.getItem(SESSION_KEY)}`);
                if (!res.ok) throw new Error('Failed to fetch notes');
                notes = await res.json();
            } catch (err) {
                console.error('Error fetching notes:', err.message);
            }
        }
        // --- View Management ---
        function showView(viewId) {
            homeView.style.display = 'none';
            transactionsView.style.display = 'none';
            savingsView.style.display = 'none';
            notesView.style.display = 'none'; // --- NEW: Hide notes view ---
            returnsView.style.display = 'none'; // --- NEW ---
            payablesView.style.display = 'none'; // üëà ADDED
            contactView.style.display = 'none'; // --- NEW ---

            homeBtn.classList.remove('active', 'ghost');
            txBtn.classList.remove('active', 'ghost');
            savingsBtn.classList.remove('active', 'ghost');
            returnsBtn.classList.remove('active', 'ghost'); // --- NEW ---
            payablesBtn.classList.remove('active', 'ghost'); // üëà ADDED
            contactBtn.classList.remove('active', 'ghost'); // --- NEW ---
            notesBtn.classList.remove('active', 'ghost'); // --- NEW: Reset notes button ---

            // --- NEW: Add 'ghost' to all buttons first (including notesBtn) ---
            [homeBtn, txBtn, savingsBtn, returnsBtn, payablesBtn, contactBtn, notesBtn].forEach(btn => btn.classList.add('ghost')); // üëà UPDATED

            if (viewId === 'home') {
                homeView.style.display = 'block';
                homeBtn.classList.add('active');
                homeBtn.classList.remove('ghost');
                // --- UPDATE: Refresh charts on showing home view to prevent shrinking ---
                renderAllCharts();
                // --- END UPDATE ---
            } else if (viewId === 'transactions') {
                transactionsView.style.display = 'block';
                txBtn.classList.add('active');
                txBtn.classList.remove('ghost');
                renderTransactions();
            } else if (viewId === 'savings') {
                savingsView.style.display = 'block';
                savingsBtn.classList.add('active');
                savingsBtn.classList.remove('ghost');
                renderSavings();
            } else if (viewId === 'returns') { // --- NEW ---
                returnsView.style.display = 'block';
                returnsBtn.classList.add('active');
                returnsBtn.classList.remove('ghost');
                renderReturns();
            } else if (viewId === 'payables') { // üëà ADDED BLOCK
                payablesView.style.display = 'block';
                payablesBtn.classList.add('active');
                payablesBtn.classList.remove('ghost');
                renderPayables();
            } else if (viewId === 'notes') { // üëà *** ADDED THIS ENTIRE BLOCK ***
                notesView.style.display = 'block';
                notesBtn.classList.add('active');
                notesBtn.classList.remove('ghost');
                renderNotes();
            } else if (viewId === 'contact') { // --- NEW ---
                contactView.style.display = 'block';
                contactBtn.classList.add('active');
                contactBtn.classList.remove('ghost');
            }
        }

        // --- Data Persistence (Backend) ---
        //
        // üî• ===================================================================
        // üî•  THIS IS THE PRIMARY BUG FIX
        // üî•  The old function fetched income and meta but never processed them.
        // üî•  This new function correctly parses all data and populates
        // üî•  the global state (monthlyIncomes, meta) on login/refresh.
        // üî• ===================================================================
        //
        async function loadDataAndRender() {
            const user = sessionStorage.getItem(SESSION_KEY);
            if (!user) return;

            try {
                // 1. Fetch all responses in parallel
                const [
                    expensesRes, incomeRes, metaRes,
                    savingsRes, returnsRes, payablesRes, notesRes
                ] = await Promise.all([
                    fetch(`/api/expenses/${user}`),
                    fetch(`/api/income/${user}`),       // Fetches the array of income objects
                    fetch(`/api/meta/${user}`),         // Fetches the single meta object
                    fetch(`/api/savings/${user}`),
                    fetch(`/api/returns/${user}`),
                    fetch(`/api/payables/${user}`),
                    fetch(`/api/notes/user/${user}`)
                ]);

                // 2. Check if all fetches were successful
                if (
                    !expensesRes.ok || !incomeRes.ok || !metaRes.ok ||
                    !savingsRes.ok || !returnsRes.ok || !payablesRes.ok || !notesRes.ok
                ) {
                    throw new Error("Failed to fetch one or more user data resources");
                }

                // 3. Parse all data from the responses
                const expensesData = await expensesRes.json();
                const incomeData = await incomeRes.json();     // This is an ARRAY: [{monthKey, income}, ...]
                const metaData = await metaRes.json();         // This is an OBJECT: {startTs, ...}
                const savingsData = await savingsRes.json();
                const returnsData = await returnsRes.json();
                const payablesData = await payablesRes.json();
                const notesData = await notesRes.json();

                // 4. üî• BUG FIX: Populate global state *from* the parsed data
                expenses = expensesData;
                savings = savingsData;
                returns = returnsData;
                payables = payablesData;
                notes = notesData;
                meta = metaData || { startTs: Date.now() }; // Assign to global meta object

                // 5. üî• BUG FIX: Process the incomeData ARRAY into the monthlyIncomes MAP
                monthlyIncomes = incomeData.reduce((acc, curr) => {
                    acc[curr.monthKey] = curr.income;
                    return acc;
                }, {}); // This correctly populates the { "YYYY-MM": amount } map

                // 6. Now that all data is loaded, set the welcome message
                const capitalizedUser = user.charAt(0).toUpperCase() + user.slice(1);
                userGreetingEl.innerHTML = `
                    Welcome, 
                    <strong style="color: var(--accent);">
                        ${escapeHtml(capitalizedUser)}
                    </strong>
                `;

                // 7. And *now* render all components that depend on this global state
                renderHome();
                renderTransactions();
                renderSavings();
                renderReturns();
                renderPayables();
                renderNotes();

            } catch (err) {
                console.error("Error loading data:", err);
                alert("Could not load your data. Please try again.");
                handleLogout();
            }
        }
        //
        // üî• ===================================================================
        // üî•  END OF BUG FIX
        // üî• ===================================================================
        //


        // --- Rendering ---
        function renderHome() {
            // --- UPDATE: 'PG Rent' is now included in totals because EXCLUDE_CATEGORY is "" ---
            const analysisExpenses = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.category !== EXCLUDE_CATEGORY)
                : expenses;

            const total = analysisExpenses.reduce((s, x) => s + Number(x.amount), 0);
            totalAll.textContent = numberFormat(total);
            const today = new Date();
            const ym = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            const monthTotal = analysisExpenses.filter(e => e.date.startsWith(ym)).reduce((s, x) => s + Number(x.amount), 0);
            totalMonth.textContent = numberFormat(monthTotal);
            countTx.textContent = analysisExpenses.length;
            renderIncomeForSelectedMonth();
            renderAllCharts();
            generateSmartInsights();
        }
        // index.html: Inside <script> tag, add this function

        function setupNoteVoiceInput() {
            if (!('webkitSpeechRecognition' in window)) {
                noteVoiceBtn.style.display = 'none';
                console.warn('Speech recognition not supported in this browser.');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                noteContentEl.value = transcript; // üëà text should update in text area to add notes
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                alert('Voice input error: ' + event.error);
            };

            noteVoiceBtn.addEventListener('click', () => {
                noteContentEl.value = 'Listening...';
                recognition.start();
            });
        }
        function renderIncomeForSelectedMonth() {
            const selectedDateStr = dateEl.value;
            if (!selectedDateStr) return;
            const monthKey = selectedDateStr.slice(0, 7);
            
            // This now works because monthlyIncomes is populated by loadDataAndRender()
            const incomeForMonth = monthlyIncomes[monthKey] || 0; 
            monthlyIncomeEl.value = incomeForMonth > 0 ? incomeForMonth : '';

            // --- UPDATE: 'PG Rent' is now included in monthTotal because EXCLUDE_CATEGORY is "" ---
            const monthTotal = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.date.startsWith(monthKey) && e.category !== EXCLUDE_CATEGORY).reduce((sum, e) => sum + Number(e.amount), 0)
                : expenses.filter(e => e.date.startsWith(monthKey)).reduce((sum, e) => sum + Number(e.amount), 0);

            const monthSavings = savings
                .filter(s => s.monthKey === monthKey)
                .reduce((sum, s) => sum + Number(s.amount), 0);
            const remaining = Math.max(0, incomeForMonth - monthTotal - monthSavings);

            remainingEl.textContent = numberFormat(remaining);
        }

        function renderTransactions() {
            txGrid.innerHTML = "";   // üî• This line is the missing fix

            const query = txSearch.value.trim().toLowerCase();

            const sorted = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            const list = query
                ? sorted.filter(e =>
                    e.title.toLowerCase().includes(query) ||
                    e.category.toLowerCase().includes(query)
                )
                : sorted;

            if (list.length === 0) {
                txGrid.innerHTML = `<div class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No transactions found.</div>`;
                groupedExpenses = {};   //üî• IMPORTANT - CLEAR THE GROUP
                return;
            }

            // üî• CLEAR groupedExpenses properly
            groupedExpenses = {};

            groupedExpenses = list.reduce((acc, tx) => {
                let d = new Date(tx.date);
                if (isNaN(d)) {
                    try { d = new Date(String(tx.date).split('T')[0]); } catch { return acc; }
                }
                if (isNaN(d)) return acc;

                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = d.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                if (!acc[monthKey]) acc[monthKey] = { label, transactions: [], total: 0 };
                acc[monthKey].transactions.push(tx);
                acc[monthKey].total += Number(tx.amount) || 0;

                return acc;
            }, {});

            const sortedKeys = Object.keys(groupedExpenses).sort().reverse();

            for (const key of sortedKeys) {
                const group = groupedExpenses[key];
                const card = document.createElement('div');
                card.className = 'month-card';
                card.dataset.key = key;
                card.innerHTML = `
            <h3>${group.label}</h3>
            <p>Total: <strong>${numberFormat(group.total)}</strong></p>
            <p>${group.transactions.length} Transactions</p>
        `;
                card.onclick = () => showMonthDetails(key, 'expense');
                txGrid.appendChild(card);
            }
        }

        // --- UPDATE: New renderSavings function ---
        function renderSavings() {
            // üî• FIX #1: Clear UI first
            savingsGrid.innerHTML = "";

            if (savings.length === 0) {
                savingsGrid.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">
            No savings recorded yet.
        </p>`;

                // üî• FIX #2: Reset groupedSavings
                groupedSavings = {};
                return;
            }

            // üî• FIX #3: Reset groupedSavings BEFORE rebuilding
            groupedSavings = {};

            groupedSavings = savings.reduce((acc, s) => {
                const [year, month] = s.monthKey.split('-');
                const label = new Date(year, month - 1, 1)
                    .toLocaleString('en-US', { month: 'long', year: 'numeric' });

                if (!acc[s.monthKey]) {
                    acc[s.monthKey] = { label, items: [], total: 0 };
                }

                acc[s.monthKey].items.push(s);
                acc[s.monthKey].total += Number(s.amount);

                return acc;
            }, {});

            const sortedKeys = Object.keys(groupedSavings).sort().reverse();

            for (const key of sortedKeys) {
                const group = groupedSavings[key];

                const card = document.createElement("div");
                card.className = "month-card";
                card.dataset.key = key;

                card.innerHTML = `
            <h3>${group.label}</h3>
            <p>Total Saved: <strong>${numberFormat(group.total)}</strong></p>
            <p>${group.items.length} Savings</p>
        `;

                card.onclick = () => showMonthDetails(key, "saving");

                savingsGrid.appendChild(card);
            }
        }


        // --- NEW: renderReturns function ---
        function renderReturns() {
            const query = returnsSearch.value.trim().toLowerCase();
            const sorted = [...returns].sort((a, b) => new Date(b.date) - new Date(a.date));
            const list = query
                ? sorted.filter(r => r.personName.toLowerCase().includes(query))
                : sorted;

            returnsGrid.innerHTML = '';
            if (list.length === 0) {
                returnsGrid.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No pending returns found.</p>`;
                return;
            }

            // Note: We are not grouping returns by month, but showing them as individual cards.
            // The prompt asked for "3 cards in a row" which the 'tx-grid' class already handles.
            for (const item of list) {
                const card = document.createElement('div');
                card.className = 'month-card'; // Re-using style for consistency
                card.innerHTML = `
                    <h3 style="color: #fbbf24;">${escapeHtml(item.personName)}</h3>
                    <p>Amount: <strong>${numberFormat(item.amount)}</strong></p>
                    <p>Date: ${formatDate(item.date)}</p>
                    <p>Mode: ${escapeHtml(item.paymentMode)}</p>
                    <div style="display:flex; gap: 8px; margin-top: 12px;">
                        <button class="btn small" onclick="editReturn('${item._id}')" style="flex:1; background-color: #60a5fa; color: #fff;">Update</button>
                        <button class="btn small danger" onclick="deleteReturn('${item._id}')" style="flex:1;">Received</button>
                    </div>`;
                returnsGrid.appendChild(card);
            }
        }

        // --- NEW: renderPayables function ---
        function renderPayables() {
            const query = payablesSearch.value.trim().toLowerCase();
            // Sort by date ascending (closest due date first)
            const sorted = [...payables].sort((a, b) => new Date(a.date) - new Date(b.date));
            const list = query
                ? sorted.filter(p => p.personName.toLowerCase().includes(query))
                : sorted;

            payablesGrid.innerHTML = '';
            if (list.length === 0) {
                payablesGrid.innerHTML = `<p class="subtitle" style="text-align:center; padding: 20px; grid-column: 1 / -1;">No upcoming payables found.</p>`;
                return;
            }

            for (const item of list) {
                const card = document.createElement('div');
                card.className = 'month-card'; // Re-using style for consistency
                card.innerHTML = `
                    <h3 style="color: #fb7185;">${escapeHtml(item.personName)}</h3>
                    <p>Amount: <strong>${numberFormat(item.amount)}</strong></p>
                    <p>Date: ${formatDate(item.date)}</p>
                    <p>Mode: ${escapeHtml(item.paymentMode)}</p>
                    <div style="display:flex; gap: 8px; margin-top: 12px;">
                        <button class="btn small" onclick="editPayable('${item._id}')" style="flex:1; background-color: #60a5fa; color: #fff;">Update</button>
                        <button class="btn small danger" onclick="deletePayable('${item._id}')" style="flex:1;">Paid</button>
                    </div>`;
                payablesGrid.appendChild(card);
            }
        }


        // --- UPDATE: Re-purposed showMonthDetails for expenses and savings ---
        window.showMonthDetails = (monthKey, type) => {

            let group, items;

            // ------------------------------
            // Identify group + items
            // ------------------------------
            if (type === "expense") {
                group = groupedExpenses[monthKey];
                items = group?.transactions;
                txModalTitle.textContent = `${group?.label || ""} - Expenses`;
            } else {
                group = groupedSavings[monthKey];
                items = group?.items;
                txModalTitle.textContent = `${group?.label || ""} - Savings`;
            }

            // ------------------------------
            // FIX 1 ‚Äî If month is empty after deletion
            // ------------------------------
            if (!group || !items || items.length === 0) {
                txModal.style.display = "none";

                if (!group || !items || items.length === 0) {
                    txModal.style.display = "none";
                    return;
                }


                return;
            }

            // ------------------------------
            // Clear modal content
            // ------------------------------
            txModalBody.innerHTML = "";

            // ------------------------------
            // Render items into modal
            // ------------------------------
            for (const e of items) {
                const itemDiv = document.createElement("div");
                itemDiv.className = "expense-item";

                if (type === "expense") {
                    const d = new Date(e.date);
                    const safeDate = isNaN(d) ? e.date : formatDate(d);
                    const safeCat = escapeHtml(e.category || "Misc");
                    const safeTitle = escapeHtml(e.title || "(Untitled)");
                    const safeAmount = numberFormat(e.amount || 0);

                    itemDiv.innerHTML = `
                <div class="expense-left">
                    <div class="cat-badge">${safeCat.slice(0, 2).toUpperCase()}</div>
                    <div>
                        <div style="font-weight:700">${safeTitle}</div>
                        <div class="meta">${safeDate} ‚Ä¢ ${safeCat}</div>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="amount">${safeAmount}</div>
                    <div class="controls">
                        <button class="btn ghost small" onclick="editExpense('${e._id}')">Edit</button>
                        <button class="btn ghost small" onclick="deleteExpense('${e._id}')">Delete</button>
                    </div>
                </div>`;
                }

                else {
                    const safeTitle = escapeHtml(e.title || "(Untitled)");
                    const safeAmount = numberFormat(e.amount || 0);

                    itemDiv.innerHTML = `
                <div class="expense-left">
                    <div class="cat-badge" style="background-color: rgba(167,139,250,0.2); color:#a78bfa;">SV</div>
                    <div>
                        <div style="font-weight:700">${safeTitle}</div>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="amount" style="color:#a78bfa;">${safeAmount}</div>
                    <div class="controls">
                        <button class="btn ghost small" onclick="editSaving('${e._id}')">Edit</button>
                        <button class="btn ghost small" onclick="deleteSaving('${e._id}')">Delete</button>
                    </div>
                </div>`;
                }

                txModalBody.appendChild(itemDiv);
            }

            // ------------------------------
            // Open modal
            // ------------------------------
            txModal.style.display = "flex";
        };


        // --- Form Handling ---
        function resetForm() {
            titleEl.value = '';
            amountEl.value = '';
            dateEl.value = new Date().toISOString().slice(0, 10);
            categoryEl.value = '';
            editingId = null;
            updateBtn.style.display = 'none';
            addBtn.style.display = 'inline-block';
            renderIncomeForSelectedMonth();
        }

        // --- NEW: Reset Saving Form ---
        function resetSavingForm() {
            savingTitleEl.value = '';
            savingAmountEl.value = '';
            savingMonthEl.value = new Date().toISOString().slice(0, 7);
            editingSavingId = null;
            updateSavingBtn.style.display = 'none';
            addSavingBtn.style.display = 'inline-block';
        }

        // --- NEW: Reset Return Form ---
        function resetReturnForm() {
            returnPersonEl.value = '';
            returnAmountEl.value = '';
            returnDateEl.value = new Date().toISOString().slice(0, 10);
            returnModeEl.value = '';
            editingReturnId = null;
            updateReturnBtn.style.display = 'none';
            addReturnBtn.style.display = 'inline-block';
        }

        // --- NEW: Reset Payable Form ---
        function resetPayableForm() {
            payablePersonEl.value = '';
            payableAmountEl.value = '';
            payableDateEl.value = new Date().toISOString().slice(0, 10);
            payableModeEl.value = '';
            editingPayableId = null;
            updatePayableBtn.style.display = 'none'; // üëà UPDATED
            addPayableBtn.style.display = 'inline-block'; // üëà UPDATED
        }

        window.editExpense = (id) => {
            txModal.style.display = 'none';
            const item = expenses.find(e => e._id === id);
            if (!item) return;
            showView('home');
            titleEl.value = item.title;
            amountEl.value = item.amount;
            dateEl.value = item.date;
            categoryEl.value = item.category;
            editingId = id;
            addBtn.style.display = 'none';
            updateBtn.style.display = 'inline-block';
            titleEl.focus();
            renderIncomeForSelectedMonth();
        };

        // --- NEW: editSaving ---
        window.editSaving = (id) => {
            txModal.style.display = 'none'; // Close the modal
            const item = savings.find(s => s._id === id);
            if (!item) return;
            showView('home'); // Go to the home view where the form is

            savingTitleEl.value = item.title;
            savingAmountEl.value = item.amount;
            savingMonthEl.value = item.monthKey;

            editingSavingId = id;
            addSavingBtn.style.display = 'none';
            updateSavingBtn.style.display = 'inline-block';
            savingTitleEl.focus();
        };

        // --- NEW: editReturn ---
        window.editReturn = (id) => {
            const item = returns.find(r => r._id === id);
            if (!item) return;
            showView('home');
            // --- NEW: Show the correct form tab ---
            toggleReturnBtn.click();
            // ---
            returnPersonEl.value = item.personName;
            returnAmountEl.value = item.amount;
            returnDateEl.value = new Date(item.date).toISOString().slice(0, 10);
            returnModeEl.value = item.paymentMode;
            editingReturnId = id;
            addReturnBtn.style.display = 'none';
            updateReturnBtn.style.display = 'inline-block';
            returnPersonEl.focus();
        };

        // --- NEW: editPayable ---
        window.editPayable = (id) => {
            const item = payables.find(p => p._id === id);
            if (!item) return;
            showView('home');
            // Show the correct form tab
            togglePayableBtn.click();

            payablePersonEl.value = item.personName;
            payableAmountEl.value = item.amount;
            payableDateEl.value = new Date(item.date).toISOString().slice(0, 10);
            payableModeEl.value = item.paymentMode;
            editingPayableId = id;
            addPayableBtn.style.display = 'none';
            updatePayableBtn.style.display = 'inline-block';
            payablePersonEl.focus();
        };

        //=---------------------------

        window.deleteExpense = async (id) => {
            if (!confirm("Are you sure you want to delete this expense?")) return;

            try {
                const res = await fetch(`/api/expenses/${id}`, { method: "DELETE" });
                if (!res.ok) throw new Error("Failed to delete expense.");

                // Reload full data
                await loadDataAndRender();

                // Re-group expenses
                renderTransactions();  // rebuild groupedExpenses

                // Identify current month from modal title
                const monthLabel = txModalTitle.textContent.split(" - ")[0];
                const newMonthKey = Object.keys(groupedExpenses)
                    .find(k => groupedExpenses[k].label === monthLabel);

                // If month still exists ‚Üí STAY in modal
                if (newMonthKey) {
                    showMonthDetails(newMonthKey, "expense");
                }
                // If month is empty ‚Üí CLOSE modal
                else {
                    txModal.style.display = "none";
                }

            } catch (err) {
                alert(err.message);
            }
        };

        // --- UPDATE: New deleteSaving function ---
        window.deleteSaving = async (id) => {
            if (!confirm("Are you sure you want to delete this saving entry?")) return;

            try {
                const res = await fetch(`/api/savings/${id}`, { method: "DELETE" });
                if (!res.ok) throw new Error("Failed to delete saving.");

                await loadDataAndRender();

                renderSavings(); // rebuild groupedSavings

                // Detect the currently opened month
                const monthLabel = txModalTitle.textContent.split(" - ")[0];
                const newMonthKey = Object.keys(groupedSavings)
                    .find(k => groupedSavings[k].label === monthLabel);

                if (newMonthKey) {
                    showMonthDetails(newMonthKey, "saving");
                } else {
                    txModal.style.display = "none";
                }

            } catch (err) {
                alert(err.message);
            }
        };

        // --- NEW: deleteReturn (Received) ---
        window.deleteReturn = async (id) => {
            if (!confirm('Are you sure you have received this payment?')) return;

            try {
                const res = await fetch(`/api/returns/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete return.');

                await loadDataAndRender();
                renderReturns(); // UI refresh

            } catch (err) { alert(err.message); }
        };


        // --- NEW: deletePayable (Paid) ---
        window.deletePayable = async (id) => {
            if (!confirm('Are you sure you have paid this?')) return;

            try {
                const res = await fetch(`/api/payables/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete payable.');

                await loadDataAndRender();
                renderPayables(); // UI refresh

            } catch (err) { alert(err.message); }
        };



        // --- Charting ---
        function getFilteredExpenses() {
            const period = chartPeriod.value;
            // --- UPDATE: 'PG Rent' is no longer filtered here ---
            const filteredBase = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.category !== EXCLUDE_CATEGORY)
                : expenses;

            if (!period.match(/^\d{4}-\d{2}$/)) return [];
            const [year, month] = period.split('-').map(Number);
            return filteredBase.filter(e => {
                const d = new Date(e.date);
                return d.getFullYear() === year && d.getMonth() === (month - 1);
            });
        }

        // --- UPDATE: New function to get filtered savings ---
        function getFilteredSavings() {
            const period = chartPeriod.value;
            if (!period.match(/^\d{4}-\d{2}$/)) return [];
            return savings.filter(s => s.monthKey === period);
        }

        function renderAllCharts() {
            // --- FIX for graph shrinking bug: ---
            // Ensure data is available before rendering
            if (!expenses || !savings) return;

            renderMonthlyBarChart();
            renderCategoryBarChart();
            renderPieChart();
            renderDonutChart();
            renderSavingsBarChart(); // --- UPDATE ---
            // --- UPDATE: New Graph ---
            renderCashFlowOverviewChart();
            // --- END UPDATE ---
            renderCashFlowTrendChart();
        }

        function createChart(canvasId, type, data, options) {
            // --- FIX for graph shrinking bug: ---
            // Check if canvas exists
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas with ID ${canvasId} not found.`);
                return;
            }
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error(`Could not get 2D context for ${canvasId}.`);
                return;
            }
            // Destroy existing instance *before* creating a new one
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            chartInstances[canvasId] = new Chart(ctx, { type, data, options });
        }

        // --- NEW: Replaced const with a function to get dynamic colors ---
        function getChartBaseOptions() {
            const isLight = document.body.classList.contains('light-mode');
            const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const tickColor = isLight ? '#0f172a' : '#FFFFFF';

            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: {
                        display: false,
                        labels: { color: tickColor } // Apply color here
                    },
                    title: { // Default title settings
                        display: true,
                        color: tickColor
                    }
                },
                scales: {
                    y: { ticks: { color: tickColor }, grid: { color: gridColor } },
                    x: { ticks: { color: tickColor }, grid: { color: gridColor } }
                }
            };
        }

        function renderMonthlyBarChart() {
            const labels = [], dataPoints = [], now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));

                // --- UPDATE: 'PG Rent' is now included ---
                const sum = (EXCLUDE_CATEGORY)
                    ? expenses.filter(e => e.date.startsWith(key) && e.category !== EXCLUDE_CATEGORY).reduce((a, b) => a + Number(b.amount), 0)
                    : expenses.filter(e => e.date.startsWith(key)).reduce((a, b) => a + Number(b.amount), 0);

                dataPoints.push(sum);
            }
            const canvas = document.getElementById('monthlyBarChart');
            if (!canvas) return; // --- FIX: Check canvas ---
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(110, 231, 183, 0.8)');
            gradient.addColorStop(1, 'rgba(110, 231, 183, 0.1)');

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();
            createChart('monthlyBarChart', 'bar',
                { labels, datasets: [{ label: 'Monthly Spend', data: dataPoints, backgroundColor: gradient, borderColor: 'var(--accent)', borderWidth: 1 }] },
                { ...baseOptions, plugins: { ...baseOptions.plugins, title: { ...baseOptions.plugins.title, text: 'Last 6 Months Spend' } } }
            );
        }

        function renderCategoryBarChart() {
            const data = getFilteredExpenses(); // This now includes 'PG Rent'
            const categoryTotals = data.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
            const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            const colors = ["#60a5fa", "#fbbf24", "#fb7185", "#a78bfa", "#f87171", "#6ee7b7", "#f472b6"];

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();
            createChart('categoryBarChart', 'bar',
                { labels: sorted.map(item => item[0]), datasets: [{ label: 'By Category', data: sorted.map(item => item[1]), backgroundColor: colors }] },
                { ...baseOptions, plugins: { ...baseOptions.plugins, title: { ...baseOptions.plugins.title, text: 'Spend by Category (Selected Month)' } } }
            );
        }

        function renderPieChart() {
            const data = getFilteredExpenses(); // This now includes 'PG Rent'
            const categoryTotals = data.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
            const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();
            createChart('pieChart', 'pie',
                { labels: sorted.map(item => item[0]), datasets: [{ data: sorted.map(item => item[1]), backgroundColor: ["#6ee7b7", "#60a5fa", "#fbbf24", "#fb7185", "#a78bfa", "#f472b6", "#f87171"] }] },
                { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: baseOptions.plugins.legend.labels.color } } } }
            );
        }

        function renderDonutChart() {
            const data = getFilteredExpenses(); // This now includes 'PG Rent'
            const spent = data.reduce((s, x) => s + Number(x.amount), 0);
            const monthKey = chartPeriod.value;
            
            // This now works because monthlyIncomes is populated
            const incomeForSelectedMonth = monthlyIncomes[monthKey] || 0; 
            const budget = incomeForSelectedMonth;

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();
            const legendOptions = { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: true, position: 'bottom', labels: { color: baseOptions.plugins.legend.labels.color } } } };

            if (budget > 0) {
                const monthSavings = getFilteredSavings().reduce((sum, s) => sum + Number(s.amount), 0);
                const remaining = Math.max(0, budget - spent - monthSavings);
                createChart('donutChart', 'doughnut',
                    { labels: ['Spent', 'Saved', 'Remaining'], datasets: [{ data: [spent, monthSavings, remaining], backgroundColor: ['#fb7185', '#a78bfa', '#60a5fa'], borderWidth: 0 }] },
                    legendOptions
                );
            } else {
                const categoryTotals = data.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
                const sorted = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
                createChart('donutChart', 'doughnut',
                    { labels: sorted.map(item => item[0]), datasets: [{ data: sorted.map(item => item[1]), backgroundColor: ["#fb7185", "#60a5fa", "#fbbf24", "#a78bfa", "#6ee7b7", "#f472b6"], borderWidth: 0 }] },
                    legendOptions
                );
            }
        }

        // --- UPDATE: New Savings Bar Chart ---
        function renderSavingsBarChart() {
            const labels = [], dataPoints = [], now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));
                const sum = savings
                    .filter(s => s.monthKey === key)
                    .reduce((a, b) => a + Number(b.amount), 0);
                dataPoints.push(sum);
            }
            const canvas = document.getElementById('savingsBarChart');
            if (!canvas) return; // --- FIX: Check canvas ---
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(167, 139, 250, 0.8)');
            gradient.addColorStop(1, 'rgba(167, 139, 250, 0.1)');

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();
            createChart('savingsBarChart', 'bar',
                { labels, datasets: [{ label: 'Monthly Savings', data: dataPoints, backgroundColor: gradient, borderColor: '#a78bfa', borderWidth: 1 }] },
                { ...baseOptions, plugins: { ...baseOptions.plugins, title: { ...baseOptions.plugins.title, text: 'Last 6 Months Savings' } } }
            );
        }

        // --- UPDATE: New Cash Flow Overview Chart ---
        function renderCashFlowOverviewChart() {
            const labels = [], incomePoints = [], expensePoints = [], savingPoints = [], now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(d.toLocaleString('default', { month: 'short' }));

                // Get Income (This now works!)
                incomePoints.push(monthlyIncomes[key] || 0);

                // Get Expenses (This now includes 'PG Rent')
                const expenseSum = (EXCLUDE_CATEGORY)
                    ? expenses.filter(e => e.date.startsWith(key) && e.category !== EXCLUDE_CATEGORY).reduce((a, b) => a + Number(b.amount), 0)
                    : expenses.filter(e => e.date.startsWith(key)).reduce((a, b) => a + Number(b.amount), 0);
                expensePoints.push(expenseSum);

                // Get Savings
                const savingSum = savings
                    .filter(s => s.monthKey === key)
                    .reduce((a, b) => a + Number(b.amount), 0);
                savingPoints.push(savingSum);
            }

            const canvas = document.getElementById('cashFlowOverviewChart');
            if (!canvas) return;

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();
            createChart('cashFlowOverviewChart', 'bar', {
                labels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomePoints,
                        backgroundColor: 'rgba(110, 231, 183, 0.6)', // --accent
                        borderColor: 'var(--accent)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expense',
                        data: expensePoints,
                        backgroundColor: 'rgba(251, 113, 133, 0.6)', // --danger
                        borderColor: '#fb7185',
                        borderWidth: 1
                    },
                    {
                        label: 'Savings',
                        data: savingPoints,
                        backgroundColor: 'rgba(167, 139, 250, 0.6)', // purple
                        borderColor: '#a78bfa',
                        borderWidth: 1
                    }
                ]
            }, {
                ...baseOptions,
                plugins: {
                    ...baseOptions.plugins,
                    title: { ...baseOptions.plugins.title, text: 'Last 6 Months: Income vs. Spend vs. Savings' },
                    legend: { display: true, position: 'bottom', labels: { color: baseOptions.plugins.legend.labels.color } } // Turn on legend
                },
                scales: {
                    y: { ...baseOptions.scales.y, beginAtZero: true },
                    x: { ...baseOptions.scales.x }
                }
            });
        }
        // --- END UPDATE ---

        function renderCashFlowTrendChart() {
            let data = getFilteredExpenses(); // This now includes 'PG Rent'

            data = data.filter(e => e.category !== 'Rent' && e.category !== 'PG Rent' && e.category !== 'RENT' && e.category !== 'rent');     //-------imp code update for removing the data of rent from graph------

            let labels = [], dataPoints = [];

            // --- UPDATE: Use getChartBaseOptions() ---
            const baseOptions = getChartBaseOptions();

            if (data.length === 0) {
                createChart('cashFlowTrendChart', 'line', { labels: [], datasets: [] }, { ...baseOptions, plugins: { ...baseOptions.plugins, title: { ...baseOptions.plugins.title, text: 'Cash Flow Trend' } } });
                return;
            }

            const [year, monthVal] = chartPeriod.value.split('-').map(Number);
            const monthIndex = monthVal - 1;
            const daysInMonth = new Date(year, monthVal, 0).getDate();

            labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const monthlyData = {};
            labels.forEach(day => monthlyData[day] = 0);

            data.forEach(tx => {
                const d = new Date(tx.date);
                monthlyData[d.getDate()] += Number(tx.amount);
            });
            dataPoints = Object.values(monthlyData);

            const canvas = document.getElementById('cashFlowTrendChart');
            if (!canvas) return; // --- FIX: Check canvas ---
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(110, 231, 183, 0.5)');
            gradient.addColorStop(1, 'rgba(110, 231, 183, 0.05)');

            createChart('cashFlowTrendChart', 'line',
                { labels, datasets: [{ label: 'Spend Trend', data: dataPoints, borderColor: '#6ee7b7', backgroundColor: gradient, fill: true, tension: 0.3, borderWidth: 2 }] },
                { ...baseOptions, plugins: { ...baseOptions.plugins, title: { ...baseOptions.plugins.title, text: 'Daily Spend (Selected Month)                                                (Note: We are not including the RENT related things in this graph for better graph UI)' } }, scales: baseOptions.scales }
            );
        }

        function generateSmartInsights() {
            const insightsContainer = document.getElementById('smart-insights');
            const now = new Date(), currentMonth = now.getMonth(), currentYear = now.getFullYear();
            const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            const prevMonthDate = new Date(currentYear, currentMonth - 1, 1);
            const prevMonth = prevMonthDate.getMonth(), prevYear = prevMonthDate.getFullYear();

            // --- UPDATE: 'PG Rent' is now included ---
            const analysisExpenses = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => e.category !== EXCLUDE_CATEGORY)
                : expenses;

            const currentMonthExpenses = analysisExpenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === currentYear && d.getMonth() === currentMonth; });
            const prevMonthExpenses = analysisExpenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === prevYear && d.getMonth() === prevMonth; });
            const currentMonthSavings = savings.filter(s => s.monthKey === currentMonthKey);

            let insights = [];
            const totalSaved = currentMonthSavings.reduce((s, e) => s + Number(e.amount), 0);
            if (totalSaved > 0) {
                insights.push(`<p class="positive">You've set aside ${numberFormat(totalSaved)} in savings this month. Great job!</p>`);
            } else {
                insights.push(`<p class="info">Don't forget to add your savings for this month.</p>`);
            }

            const totalCurrentSpent = currentMonthExpenses.reduce((s, e) => s + Number(e.amount), 0);
            
            // This now works because monthlyIncomes is populated
            const currentIncome = monthlyIncomes[currentMonthKey] || 0; 
            if (currentIncome > 0) {
                const percentSpent = Math.round(((totalCurrentSpent + totalSaved) / currentIncome) * 100);
                if (percentSpent > 100) {
                    insights.push(`<p class="negative">You've used ${percentSpent}% of your income. Be careful!</p>`);
                } else if (percentSpent > 0) {
                    insights.push(`<p class="info">You've used ${percentSpent}% of your monthly income (including savings).</p>`);
                }
            }

            if (currentMonthExpenses.length > 0) {
                const currentCategoryTotals = currentMonthExpenses.reduce((acc, { category, amount }) => { acc[category] = (acc[category] || 0) + Number(amount); return acc; }, {});
                const topCategory = Object.entries(currentCategoryTotals).sort((a, b) => b[1] - a[1])[0];
                insights.push(`<p class="info">Your top expense this month is <strong>${escapeHtml(topCategory[0])}</strong> at ${numberFormat(topCategory[1])}.</p>`);
            }

            const totalPrevSpent = prevMonthExpenses.reduce((s, e) => s + Number(e.amount), 0);
            if (totalPrevSpent > 0 && totalCurrentSpent > 0) {
                const totalPercentChange = Math.round(((totalCurrentSpent - totalPrevSpent) / totalPrevSpent) * 100);
                if (totalPercentChange > 10) insights.unshift(`<p class="negative">Overall spending is up by ${totalPercentChange}% from last month.</p>`);
                else if (totalPercentChange < -10) insights.unshift(`<p class="positive">Great job! Spending is down by ${-totalPercentChange}% from last month.</p>`);
                else insights.push(`<p class="info">Your spending is stable compared to last month.</p>`);
            }

            // --- NEW: Add insight for pending returns ---
            const totalPendingReturns = returns.reduce((sum, r) => sum + Number(r.amount), 0);
            if (totalPendingReturns > 0) {
                insights.push(`<p class="info">You have <strong>${numberFormat(totalPendingReturns)}</strong> in pending returns.</p>`);
            }

            // --- NEW: Add insight for pending payables ---
            const totalPendingPayables = payables.reduce((sum, p) => sum + Number(p.amount), 0);
            if (totalPendingPayables > 0) {
                insights.push(`<p class="info">You have <strong>${numberFormat(totalPendingPayables)}</strong> in upcoming payables.</p>`);
            }

            insightsContainer.innerHTML = insights.length > 0 ? insights.slice(0, 3).join('') : '<p class="subtitle">Add transactions to see insights.</p>';
        }

        // --- Data Export & PDF Report Generation ---

        // UPDATED: Added 'monthKey' parameter
        function generatePdfReport(dataToExport, filename, periodTitle, monthKey) {
            document.body.style.cursor = 'wait';
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("Report generation library not loaded. Please refresh.");
                document.body.style.cursor = 'default';
                return;
            }

            const doc = new jsPDF();
            const user = sessionStorage.getItem(SESSION_KEY) || 'User';
            const capitalizedUser = user.charAt(0).toUpperCase() + user.slice(1);
            const totalPagesExp = '{total_pages_count_string}';

            const header = (data) => {
                doc.setFontSize(20); doc.setTextColor(40); doc.setFont('helvetica', 'bold');
                doc.text('TALYEXP', 15, 20);
                doc.setFontSize(10); doc.setTextColor(100); doc.setFont('helvetica', 'normal');
                doc.text(`Expense Report for ${capitalizedUser}`, 15, 26);
                doc.text(`Period: ${periodTitle}`, doc.internal.pageSize.getWidth() - 15, 20, { align: 'right' });
                doc.text(`Generated: ${new Date().toLocaleDateString('en-GB')}`, doc.internal.pageSize.getWidth() - 15, 26, { align: 'right' });
                doc.setLineWidth(0.5); doc.line(15, 30, doc.internal.pageSize.getWidth() - 15, 30);
            };

            const footer = (data) => {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(8); doc.setTextColor(150);
                doc.text(`Page ${data.pageNumber} of ${totalPagesExp}`, doc.internal.pageSize.getWidth() / 2, 287, { align: 'center' });
                doc.text('TALYEXP | Confidential', 15, 287);
            };

            const total = dataToExport.reduce((sum, item) => sum + Number(item.amount), 0);
            const count = dataToExport.length;
            // const average = count > 0 ? total / count : 0; // <-- REMOVED
            const categoryTotals = dataToExport.reduce((acc, { category, amount }) => {
                acc[category] = (acc[category] || 0) + Number(amount); return acc;
            }, {});
            const topCategory = Object.keys(categoryTotals).length > 0 ? Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0] : ['N/A', 0];

            // --- UPDATED: PDF Summary Layout ---
            const summaryY = 40;
            doc.setFillColor(245, 245, 245);
            doc.roundedRect(14, summaryY, doc.internal.pageSize.getWidth() - 28, 25, 3, 3, 'F');
            doc.setFontSize(10); doc.setTextColor(50);

            doc.text(`Total Expenses:`, 20, summaryY + 7);
            doc.text(`Total Transactions:`, 20, summaryY + 14);

            doc.setFont('helvetica', 'bold');
            doc.text(numberFormat(total), 75, summaryY + 7); // Adjusted X
            doc.text(String(count), 75, summaryY + 14); // Adjusted X
            doc.setFont('helvetica', 'normal'); // Reset

            // Conditional layout for income vs. top category
            // This now works because monthlyIncomes is populated
            if (monthKey && monthlyIncomes[monthKey]) {
                // Monthly report layout
                const selectedIncome = monthlyIncomes[monthKey];
                doc.text(`Selected Month Income:`, doc.internal.pageSize.getWidth() / 2, summaryY + 7);
                doc.text(`Top Category:`, doc.internal.pageSize.getWidth() / 2, summaryY + 14);

                doc.setFont('helvetica', 'bold');
                doc.text(numberFormat(selectedIncome), doc.internal.pageSize.getWidth() / 2 + 50, summaryY + 7);
                doc.text(`${topCategory[0]} (${numberFormat(topCategory[1])})`, doc.internal.pageSize.getWidth() / 2 + 50, summaryY + 14);
            } else {
                // Yearly/Quarterly report layout (no income)
                doc.text(`Top Category:`, doc.internal.pageSize.getWidth() / 2, summaryY + 7); // Moved up

                doc.setFont('helvetica', 'bold');
                doc.text(`${topCategory[0]} (${numberFormat(topCategory[1])})`, doc.internal.pageSize.getWidth() / 2 + 50, summaryY + 7); // Moved up
            }
            // --- END: PDF Summary Layout Update ---

            doc.autoTable({
                head: [['Date', 'Title', 'Category', 'Amount (INR)']],
                body: dataToExport.map(item => [formatDate(item.date), item.title, item.category, Number(item.amount).toLocaleString('en-IN', { minimumFractionDigits: 2 })]),
                startY: summaryY + 30,
                margin: { top: 35 },
                didDrawPage: (data) => { header(data); footer(data); },
                headStyles: { fillColor: [41, 128, 186], textColor: 255, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 248, 255] },
                styles: { halign: 'left', cellPadding: 2.5 },
                columnStyles: { 3: { halign: 'right' } }
            });

            if (typeof doc.putTotalPages === 'function') {
                doc.putTotalPages(totalPagesExp);
            }

            doc.save(filename);
            document.body.style.cursor = 'default';
        }

        function handleDownload() {
            const period = downloadPeriod.value;
            if (!period.match(/^\d{4}-\d{2}$/)) { alert("Please select a valid month."); return; }
            const [year, monthVal] = period.split('-').map(Number);
            const monthIndex = monthVal - 1;

            // --- UPDATE: 'PG Rent' is now included in downloads ---
            const dataToExport = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === year && d.getMonth() === monthIndex && e.category !== EXCLUDE_CATEGORY; })
                : expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === year && d.getMonth() === monthIndex; });

            const periodTitle = new Date(year, monthIndex, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
            if (dataToExport.length === 0) { alert(`No data available for ${periodTitle}.`); return; }

            // UPDATED: Pass 'period' (monthKey) to the report function
            generatePdfReport(dataToExport, `TALYEXP_${periodTitle.replace(' ', '_')}.pdf`, periodTitle, period);
        }

        function handleYearlyDownload() {
            const year = prompt("Enter year for report:", new Date().getFullYear());
            if (!year || isNaN(year)) { alert("Invalid year."); return; }
            // --- UPDATE: 'PG Rent' is now included in downloads ---
            const data = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => new Date(e.date).getFullYear() === parseInt(year) && e.category !== EXCLUDE_CATEGORY)
                : expenses.filter(e => new Date(e.date).getFullYear() === parseInt(year));

            if (data.length === 0) { alert(`No data for the year ${year}.`); return; }
            generatePdfReport(data, `talyexp_yearly_${year}.pdf`, `Year ${year}`); // No monthKey passed
        }

        function handleQuarterlyDownload() {
            const year = prompt("Enter year for report:", new Date().getFullYear());
            if (!year || isNaN(year)) { alert("Invalid year."); return; }
            const quarter = prompt("Enter quarter (1-4):");
            if (!quarter || !['1', '2', '3', '4'].includes(quarter)) { alert("Invalid quarter."); return; }
            const q = parseInt(quarter), startMonth = (q - 1) * 3, endMonth = startMonth + 2;

            // --- UPDATE: 'PG Rent' is now included in downloads ---
            const data = (EXCLUDE_CATEGORY)
                ? expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === parseInt(year) && d.getMonth() >= startMonth && d.getMonth() <= endMonth && e.category !== EXCLUDE_CATEGORY; })
                : expenses.filter(e => { const d = new Date(e.date); return d.getFullYear() === parseInt(year) && d.getMonth() >= startMonth && d.getMonth() <= endMonth; });

            if (data.length === 0) { alert(`No data for Q${q} ${year}.`); return; }
            generatePdfReport(data, `talyexp_quarterly_Q${q}-${year}.pdf`, `Quarter ${q}, ${year}`); // No monthKey passed
        }

        // --- Data Reset ---
        function checkYearReset() {
            // --- UPDATE: 1-Year Reset functionality is now disabled ---
            return false;
            // const oneYear = 31536000000; // Original value
            // if (meta.startTs && (Date.now() - meta.startTs) >= oneYear) { resetModal.style.display = 'flex'; return true; }
            // return false;
        }

        // --- NEW: Helper function to get password from modal ---
        function getPasswordConfirmation(title = 'Confirm Action', message = 'To confirm, please enter your login password:', btnText = 'Confirm') {
            // Set modal text
            passwordModalTitle.textContent = title;
            passwordModalMessage.textContent = message;
            passwordModalConfirm.textContent = btnText;
            passwordModalConfirm.classList.remove('danger'); // Ensure it's not always danger
            if (btnText.toLowerCase().includes('delete') || btnText.toLowerCase().includes('reset')) {
                passwordModalConfirm.classList.add('danger');
            }

            passwordModal.style.display = 'flex';
            passwordModalInput.value = '';
            passwordModalInput.focus();

            return new Promise((resolve) => {
                const confirmHandler = () => {
                    cleanup();
                    resolve(passwordModalInput.value);
                };

                const cancelHandler = () => {
                    cleanup();
                    resolve(null); // Resolve with null if cancelled
                };

                const keypressHandler = (e) => {
                    if (e.key === 'Enter') {
                        confirmHandler();
                    }
                };

                const cleanup = () => {
                    passwordModalConfirm.removeEventListener('click', confirmHandler);
                    passwordModalCancel.removeEventListener('click', cancelHandler);
                    passwordModal.removeEventListener('click', modalClickHandler);
                    passwordModalInput.removeEventListener('keypress', keypressHandler);
                    passwordModal.style.display = 'none';
                    // Reset modal text to default
                    passwordModalTitle.textContent = 'Confirm Action';
                    passwordModalMessage.textContent = 'To confirm, please enter your login password:';
                    passwordModalConfirm.textContent = 'Confirm';
                    passwordModalConfirm.classList.remove('danger');
                };

                const modalClickHandler = (e) => {
                    if (e.target === passwordModal) {
                        cancelHandler();
                    }
                };

                passwordModalConfirm.addEventListener('click', confirmHandler);
                passwordModalCancel.addEventListener('click', cancelHandler);
                passwordModal.addEventListener('click', modalClickHandler);
                passwordModalInput.addEventListener('keypress', keypressHandler);
            });
        }


        async function handleFullReset() {
            if (confirm('DANGER! This will permanently delete all your data (expenses, savings, returns, and payables). Are you sure?')) {

                // --- UPDATE: Use password modal with custom text ---
                const password = await getPasswordConfirmation(
                    'Confirm App Reset',
                    'This will delete all transactions, savings, and other app data. This CANNOT be undone. Please enter your password to confirm.',
                    'Confirm Reset'
                );

                if (!password) {
                    // User cancelled the modal
                    alert("Password not entered. Reset cancelled.");
                    return;
                }
                const user = sessionStorage.getItem(SESSION_KEY);
                if (!user) { alert('No user session found. Please log in again.'); return; }
                try {
                    const verifyRes = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: user, password: password })
                    });
                    if (!verifyRes.ok) { alert('Invalid credentials. Cannot reset.'); return; }

                    // --- UPDATE: Add loading state to modal button ---
                    passwordModalConfirm.disabled = true;
                    passwordModalConfirm.textContent = 'Resetting...';

                    alert("Password confirmed. Proceeding with data reset.");
                    // --- NEW: Add payables delete ---
                    const [expRes, incRes, saveRes, retRes, payRes, metaRes, notesRes] = await Promise.all([
                        fetch(`/api/expenses/user/${user}`, { method: 'DELETE' }),
                        fetch(`/api/income/user/${user}`, { method: 'DELETE' }),
                        fetch(`/api/savings/user/${user}`, { method: 'DELETE' }),
                        fetch(`/api/returns/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                        fetch(`/api/payables/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                        fetch(`/api/notes/user/${user}`, { method: 'DELETE' }), // --- NEW ---
                        fetch('/api/meta/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user }) })
                    ]);

                    // --- UPDATE: Reset button text ---
                    passwordModalConfirm.disabled = false;
                    passwordModalConfirm.textContent = 'Confirm Reset';

                    if (!expRes.ok || !incRes.ok || !saveRes.ok || !retRes.ok || !payRes.ok || !metaRes.ok || !notesRes.ok) { // --- NEW ---
                        throw new Error(`Reset failed on the server after password verification.`);
                    }
                    alert('All your application data has been reset successfully.');
                    location.reload();
                } catch (err) {
                    // --- UPDATE: Reset button text on error ---
                    passwordModalConfirm.disabled = false;
                    passwordModalConfirm.textContent = 'Confirm Reset';

                    console.error("Reset error:", err);
                    alert(`An error occurred during reset. Please try again.`);
                }
            }
        }

        // --- NEW: Delete Account Function ---
        async function handleDeleteAccount() {
            if (!confirm('DANGER! This will permanently delete your entire account and all associated data (expenses, savings, notes, etc.). This action CANNOT be undone. Are you sure?')) {
                return;
            }

            // Use the existing password modal with custom text
            const password = await getPasswordConfirmation(
                'Confirm Account Deletion',
                'This is your final confirmation. Deleting your account is permanent. Please enter your password to proceed.',
                'Delete My Account'
            );

            if (!password) {
                alert("Password not entered. Account deletion cancelled.");
                return;
            }

            const user = sessionStorage.getItem(SESSION_KEY);
            if (!user) { alert('No user session found. Please log in again.'); return; }

            try {
                // 1. Verify password (server will verify again, but this is a good pre-check)
                const verifyRes = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: password })
                });

                if (!verifyRes.ok) {
                    alert('Invalid credentials. Account deletion cancelled.');
                    return;
                }

                // 2. If password is correct, show loading state
                alert("Password confirmed. Proceeding with account deletion...");

                passwordModalConfirm.disabled = true;
                passwordModalConfirm.textContent = 'Deleting...';

                // 3. Call the new delete endpoint
                const deleteRes = await fetch(`/api/account/delete`, {
                    method: 'POST', // Using POST for authenticated delete
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: password }) // Send credentials
                });

                // 4. Reset button text
                passwordModalConfirm.disabled = false;
                passwordModalConfirm.textContent = 'Delete My Account'; // Reset text

                if (!deleteRes.ok) {
                    const errData = await deleteRes.json();
                    throw new Error(errData.error || 'Account deletion failed on the server.');
                }

                alert('Your account has been permanently deleted. You will now be logged out.');
                handleLogout(); // This will reload to the login page

            } catch (err) {
                // Reset button text on error
                passwordModalConfirm.disabled = false;
                passwordModalConfirm.textContent = 'Delete My Account';

                console.error("Account deletion error:", err);
                alert(`An error occurred during account deletion: ${err.message}`);
            }
        }


        // --- Voice Input Logic ---
        function setupVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { voiceBtn.style.display = 'none'; return; }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-IN';
            recognition.interimResults = false;
            voiceBtn.addEventListener('click', () => { voiceBtn.classList.add('active'); recognition.start(); });
            recognition.onresult = (event) => parseVoiceCommand(event.results[0][0].transcript.toLowerCase());
            recognition.onspeechend = () => recognition.stop();
            recognition.onerror = (event) => console.error('Speech recognition error:', event.error);
            recognition.onend = () => voiceBtn.classList.remove('active');
        }

        function parseVoiceCommand(command) {
            const amountMatch = command.match(/(?:amount|spend|cost)\s+([\d,.]+)/);
            if (amountMatch) amountEl.value = amountMatch[1].replace(/,/g, '');
            const categories = ['food', 'transport', 'bills', 'shopping', 'entertainment', 'health', 'other'];
            const categoryMatch = command.match(/category\s+([a-zA-Z]+)/);
            let category = '';
            if (categoryMatch && categories.includes(categoryMatch[1])) category = categoryMatch[1];
            else { for (const cat of categories) { if (command.includes(cat)) { category = cat; break; } } }
            if (category) categoryEl.value = category.charAt(0).toUpperCase() + category.slice(1);
            const titleMatch = command.match(/title\s+(.+?)(?=\s+amount|\s+category|$)/);
            if (titleMatch) titleEl.value = titleMatch[1].trim().charAt(0).toUpperCase() + titleMatch[1].trim().slice(1);
            if (command.includes('today')) dateEl.value = new Date().toISOString().slice(0, 10);
            else if (command.includes('yesterday')) {
                const d = new Date(); d.setDate(d.getDate() - 1);
                dateEl.value = d.toISOString().slice(0, 10);
            }
            if (command.match(/submit|add|save/) && titleEl.value && amountEl.value) addBtn.click();
        }

        // --- Calculator Logic ---
        function setupCalculator() {
            const display = document.getElementById('calc-display');
            const keysContainer = document.querySelector('.calc-keys');
            let expression = '';
            if (!display || !keysContainer) return;
            keysContainer.addEventListener('click', (event) => {
                const key = event.target.closest('.calc-key');
                if (!key) return;
                const keyValue = key.dataset.key;
                if (keyValue === 'clear') expression = '';
                else if (keyValue === '=') {
                    try {
                        if (/^[0-9+\-*/.() ]+$/.test(expression)) expression = String(eval(expression));
                        else expression = 'Error';
                    } catch { expression = 'Error'; }
                } else {
                    if (expression === 'Error') expression = '';
                    expression += keyValue;
                }
                display.textContent = expression || '0';
            });
        }

        function populateMonthDropdowns() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonthKey = `${currentYear}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            [downloadPeriod, chartPeriod].forEach(dropdown => {
                dropdown.innerHTML = '';
                for (let i = 0; i < 12; i++) {
                    const monthName = months[i];
                    const monthKey = `${currentYear}-${String(i + 1).padStart(2, '0')}`;
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = `${monthName} ${currentYear}`;
                    dropdown.appendChild(option);
                }
            });
            chartPeriod.value = currentMonthKey;
            downloadPeriod.value = currentMonthKey;
        }

        // --- NEW: Theme Toggling ---
        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('talyexp_theme', isLight ? 'light' : 'dark');

            // Re-render all charts to apply new theme colors
            // We only need to do this if the home view is active
            if (homeView.style.display === 'block') {
                renderAllCharts();
            }
        }

        // --- App Initialization ---
        function init() {
            // --- NEW: Load saved theme ---
            const savedTheme = localStorage.getItem('talyexp_theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
            // --- End new code ---

            dateEl.value = new Date().toISOString().slice(0, 10);
            returnDateEl.value = new Date().toISOString().slice(0, 10); // --- NEW ---
            payableDateEl.value = new Date().toISOString().slice(0, 10); // --- NEW ---
            savingMonthEl.value = new Date().toISOString().slice(0, 7);
            populateMonthDropdowns();

            authBtn.addEventListener('click', handleAuth);
            loginPassEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAuth(); });
            confirmPassEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAuth(); }); // --- UPDATE ---

            // --- FIX for auth toggle link ---
            authToggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthMode(authMode === 'login' ? 'register' : 'login');
            });
            forgotPassLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthMode('reset');
            });

            logoutBtn.addEventListener('click', handleLogout);
            fullResetBtn.addEventListener('click', handleFullReset);
            homeBtn.addEventListener('click', () => showView('home'));
            txBtn.addEventListener('click', () => showView('transactions'));
            savingsBtn.addEventListener('click', () => showView('savings'));
            returnsBtn.addEventListener('click', () => showView('returns')); // --- NEW ---
            payablesBtn.addEventListener('click', () => showView('payables')); // üëà ADDED
            contactBtn.addEventListener('click', () => showView('contact')); // --- NEW ---
            notesBtn.addEventListener('click', () => showView('notes')); // --- NEW: Added listener ---
            themeToggleBtn.addEventListener('click', toggleTheme); // --- NEW ---
            noteUpdateBtn.addEventListener('click', handleUpdateNote); // üëà ADD THIS LINE
            noteResetBtn.addEventListener('click', resetNoteForm); // üëà ADD THIS LINE
            chartPeriod.addEventListener('change', renderAllCharts);
            dateEl.addEventListener('change', renderIncomeForSelectedMonth);
            setupVoiceInput(); // For expenses form
            setupNoteVoiceInput(); // üëà ADD THIS LINE for notes form

            // --- NEW: Settings Popout Logic ---
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsPopout = document.getElementById('settings-popout');
            const deleteAccountBtn = document.getElementById('deleteAccountBtn'); // For request 2

            if (settingsBtn && settingsPopout) {
                settingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent document click listener from closing it immediately

                    // Toggle for both popout and button (for arrow)
                    const isActive = settingsPopout.classList.toggle('active');
                    settingsBtn.classList.toggle('active', isActive);

                    // Adjust positioning for desktop view
                    if (window.innerWidth > 1100) {
                        const btnRect = settingsBtn.getBoundingClientRect();
                        const navLinksRect = navLinks.getBoundingClientRect();
                        // Position relative to the navLinks container
                        settingsPopout.style.bottom = (navLinksRect.bottom - btnRect.bottom) + 'px';
                        settingsPopout.style.right = (btnRect.width + 10) + 'px'; // Pops out to the left
                    } else {
                        // Reset desktop styles for mobile view
                        settingsPopout.style.bottom = '';
                        settingsPopout.style.right = '';
                    }
                });
            }

            // Add listener for new delete button
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            }
            // --- END: Settings Popout Logic ---


            hamburgerBtn.addEventListener('click', (e) => { e.stopPropagation(); navLinks.classList.toggle('active'); });
            document.addEventListener('click', (e) => {
                if (!navLinks.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                    navLinks.classList.remove('active');
                }

                // NEW: Close settings popout if clicking outside
                if (settingsPopout && !settingsPopout.contains(e.target) && !settingsBtn.contains(e.target)) {
                    settingsPopout.classList.remove('active');
                    settingsBtn.classList.remove('active');
                }
            });

            // --- NEW: Toggle for note creation form ---
            const toggleNoteFormBtn = document.getElementById('toggleNoteFormBtn');
            const noteCreationCard = document.getElementById('note-creation-card');
            if (toggleNoteFormBtn && noteCreationCard) {
                toggleNoteFormBtn.addEventListener('click', () => {
                    const isVisible = noteCreationCard.style.display !== 'none';
                    if (isVisible) {
                        noteCreationCard.style.display = 'none';
                        toggleNoteFormBtn.textContent = 'Show Form';
                    } else {
                        noteCreationCard.style.display = 'block';
                        toggleNoteFormBtn.textContent = 'Hide Form';
                    }
                });
            }
            // --- END NEW ---

            noteViewModal.addEventListener('click', (e) => {
                if (e.target === noteViewModal || e.target.closest('.close-btn')) {
                    noteViewModal.style.display = 'none';
                }
            });

            // --- NEW: About Me Modal Listeners ---
            aboutMeBtn.addEventListener('click', () => {
                aboutMeModal.style.display = 'flex';
            });
            closeAboutMeModalBtn.addEventListener('click', () => {
                aboutMeModal.style.display = 'none';
            });
            aboutMeModal.addEventListener('click', (e) => {
                if (e.target === aboutMeModal) {
                    aboutMeModal.style.display = 'none';
                }
            });

            // --- NEW: Form Toggle Logic ---
            toggleReturnBtn.addEventListener('click', () => {
                returnFormContainer.style.display = 'block';
                payableFormContainer.style.display = 'none';
                toggleReturnBtn.classList.add('active');
                togglePayableBtn.classList.remove('active');
            });
            togglePayableBtn.addEventListener('click', () => {
                returnFormContainer.style.display = 'none';
                payableFormContainer.style.display = 'block';
                toggleReturnBtn.classList.remove('active');
                togglePayableBtn.classList.add('active');
            });


            // --- UPDATE: Contact Form Logic (now saves to server) ---
            contactForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameVal = contactName.value.trim();
                const phoneVal = contactPhone.value.trim();
                if (!nameVal || !phoneVal) {
                    alert('Please fill in the required fields (Name and Phone Number).');
                    return;
                }

                // --- NEW: Get other form values ---
                const emailVal = document.getElementById('contact-email').value.trim();
                const queryVal = document.getElementById('contact-query').value.trim();
                const userVal = sessionStorage.getItem(SESSION_KEY);

                // --- NEW: Find the submit button to disable it ---
                const submitBtn = contactForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                try {
                    const res = await fetch('/api/contact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user: userVal,
                            name: nameVal,
                            phone: phoneVal,
                            email: emailVal,
                            query: queryVal
                        })
                    });

                    if (!res.ok) {
                        const errData = await res.json();
                        throw new Error(errData.error || 'Failed to submit form.');
                    }

                    alert('Thank you for your message! We will get back to you shortly.');
                    contactForm.reset();
                    showView('home');

                } catch (err) {
                    alert(`Error: ${err.message}`);
                } finally {
                    // --- NEW: Re-enable button ---
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                }
            });

            addBtn.addEventListener('click', async () => {
                const t = titleEl.value.trim(), a = parseFloat(amountEl.value || 0), d = dateEl.value, c = categoryEl.value.trim() || 'Other';
                if (!t || !a || !d) { alert('Please enter title, amount, and date.'); return; }
                try {
                    const res = await fetch('/api/expenses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), title: t, amount: a, date: d, category: c })
                    });
                    if (!res.ok) throw new Error('Failed to add expense');
                    await loadDataAndRender();
                    resetForm();
                } catch (err) { alert(err.message); }
            });

            addSavingBtn.addEventListener('click', async () => {
                const t = savingTitleEl.value.trim(), a = parseFloat(savingAmountEl.value || 0), m = savingMonthEl.value;
                if (!t || !a || !m) { alert('Please enter title, amount, and month for saving.'); return; }
                try {
                    const res = await fetch('/api/savings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), title: t, amount: a, monthKey: m })
                    });
                    if (!res.ok) throw new Error('Failed to add saving');
                    await loadDataAndRender();
                    resetSavingForm();
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Add Return ---
            addReturnBtn.addEventListener('click', async () => {
                const p = returnPersonEl.value.trim(), a = parseFloat(returnAmountEl.value || 0), d = returnDateEl.value, m = returnModeEl.value.trim() || 'N/A';
                if (!p || !a || !d) { alert('Please enter person name, amount, and date.'); return; }
                try {
                    const res = await fetch('/api/returns', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to add pending return');
                    await loadDataAndRender();
                    resetReturnForm();
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Add Payable ---
            addPayableBtn.addEventListener('click', async () => {
                const p = payablePersonEl.value.trim(), a = parseFloat(payableAmountEl.value || 0), d = payableDateEl.value, m = payableModeEl.value.trim() || 'N/A';
                if (!p || !a || !d) { alert('Please enter person name, amount, and due date.'); return; }
                try {
                    const res = await fetch('/api/payables', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to add payable');
                    await loadDataAndRender(); // Reloads all data, including payables
                    resetPayableForm();
                    alert('Payable added successfully!');
                } catch (err) { alert(err.message); }
            });

            updateBtn.addEventListener('click', async () => {
                const t = titleEl.value.trim(), a = parseFloat(amountEl.value || 0), d = dateEl.value, c = categoryEl.value.trim() || 'Other';
                if (!t || !a || !d || !editingId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/expenses/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: t, amount: a, date: d, category: c })
                    });
                    if (!res.ok) throw new Error('Failed to update expense');
                    await loadDataAndRender();
                    resetForm();
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Update Saving ---
            updateSavingBtn.addEventListener('click', async () => {
                const t = savingTitleEl.value.trim(), a = parseFloat(savingAmountEl.value || 0), m = savingMonthEl.value;
                if (!t || !a || !m || !editingSavingId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/savings/${editingSavingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: t, amount: a, monthKey: m })
                    });
                    if (!res.ok) throw new Error('Failed to update saving');
                    await loadDataAndRender();
                    resetSavingForm();
                    if (savingsView.style.display === 'block') renderSavings(); // Refresh view if active
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Update Return ---
            updateReturnBtn.addEventListener('click', async () => {
                const p = returnPersonEl.value.trim(), a = parseFloat(returnAmountEl.value || 0), d = returnDateEl.value, m = returnModeEl.value.trim() || 'N/A';
                if (!p || !a || !d || !editingReturnId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/returns/${editingReturnId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to update pending return');
                    await loadDataAndRender();
                    resetReturnForm();
                    if (returnsView.style.display === 'block') renderReturns(); // Refresh view
                } catch (err) { alert(err.message); }
            });

            // --- NEW: Update Payable ---
            updatePayableBtn.addEventListener('click', async () => {
                const p = payablePersonEl.value.trim(), a = parseFloat(payableAmountEl.value || 0), d = payableDateEl.value, m = payableModeEl.value.trim() || 'N/A';
                if (!p || !a || !d || !editingPayableId) { alert('Please fill all fields.'); return; }
                try {
                    const res = await fetch(`/api/payables/${editingPayableId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ personName: p, amount: a, date: d, paymentMode: m })
                    });
                    if (!res.ok) throw new Error('Failed to update payable');
                    await loadDataAndRender();
                    resetPayableForm();
                    if (payablesView.style.display === 'block') renderPayables(); // Refresh view
                } catch (err) { alert(err.message); }
            });

            resetBtn.addEventListener('click', resetForm);
            txSearch.addEventListener('input', renderTransactions);
            returnsSearch.addEventListener('input', renderReturns); // --- NEW ---
            payablesSearch.addEventListener('input', renderPayables); // üëà ADDED

            saveIncomeBtn.addEventListener('click', async () => {
                const selectedDateStr = dateEl.value;
                if (!selectedDateStr) { alert('Please select a date.'); return; }
                const monthKey = selectedDateStr.slice(0, 7);
                const incomeValue = Number(monthlyIncomeEl.value || 0);
                try {
                    const res = await fetch('/api/income', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user: sessionStorage.getItem(SESSION_KEY), monthKey, income: incomeValue })
                    });
                    if (!res.ok) throw new Error('Failed to save income');
                    monthlyIncomes[monthKey] = incomeValue; // Update local state
                    renderIncomeForSelectedMonth();
                    renderAllCharts();
                    alert(`Income saved for ${new Date(monthKey + '-02').toLocaleString('default', { month: 'long', year: 'numeric' })}.`);
                } catch (err) { alert(err.message); }
            });

            downloadBtn.addEventListener('click', handleDownload);
            // --- UPDATE: Event listener for 1-year reset button removed ---
            // downloadArchiveBtn.addEventListener('click', handleArchiveAndReset);
            closeModalBtn.addEventListener('click', () => txModal.style.display = 'none');
            txModal.addEventListener('click', (e) => { if (e.target === txModal) txModal.style.display = 'none'; });
            downloadYearlyBtn.addEventListener('click', handleYearlyDownload);
            downloadQuarterlyBtn.addEventListener('click', handleQuarterlyDownload);
            calculatorBtn.addEventListener('click', () => { calculatorModal.style.display = 'flex'; });
            calculatorModal.addEventListener('click', (e) => { if (e.target === calculatorModal) calculatorModal.style.display = 'none'; });

            // ---------
            // // --- NEW: Add this line to fix resizing ---
            window.addEventListener('resize', debounce(renderAllCharts, 250));
            // // ---------

            // This will cause a very bad user experience. Not recommended.
            // window.addEventListener('resize', () => {
            //     location.reload();
            // });


            setupCalculator();
            setupVoiceInput();

            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(async () => {
                    splashScreen.style.display = 'none';
                    if (isLoggedIn()) {
                        appContainer.style.display = 'flex';
                        await loadDataAndRender(); // This now correctly populates all data
                    } else {
                        loginScreen.style.display = 'flex';
                    }
                }, 500);
            }, 1500);
        }

        init();


    </script>

</body>

</html>
